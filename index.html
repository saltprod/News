<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Telegram MiniApp — Моя лента</title>
  <style>
    :root{
      --bg:#071022; --surface:#081426; --text:#e6eef8; --muted:#9fb3d6; --accent:#2a8cff;
      --accent-rgb:42,140,255; --pill-bg:rgba(255,255,255,0.04); --btn-alpha:0.12
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    canvas#bgCanvas{position:fixed;left:0;top:0;right:0;bottom:0;z-index:0;pointer-events:none}
    .app{position:relative;z-index:2;max-width:960px;margin:0 auto}
    header{position:sticky;top:0;z-index:3;background:linear-gradient(180deg, rgba(6,10,20,0.28), transparent);padding:14px}
    .title-row{display:flex;align-items:center;justify-content:space-between}
    h1{font-size:18px;margin:0}
    .user{color:var(--muted);font-size:13px;margin-top:6px}
    main{padding:12px 18px 110px}
    .news-list{display:flex;flex-direction:column;gap:10px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:10px;padding:12px;cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
    .card h4{margin:0 0 6px 0}
    .card p{margin:0;color:var(--muted);font-size:13px}
    .meta{display:flex;justify-content:space-between;margin-top:8px;font-size:12px;color:var(--muted)}
    .bottom-bar{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(6,10,20,0.6);padding:8px;border-radius:999px;display:flex;gap:8px;z-index:4}
    .btn{background:rgba(var(--accent-rgb),var(--btn-alpha));border:0;padding:8px 12px;border-radius:8px;color:var(--text);cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
    .fab-translate{position:fixed;right:18px;bottom:96px;background:rgba(var(--accent-rgb),0.98);color:white;border-radius:999px;padding:12px 14px;z-index:5;box-shadow:0 6px 18px rgba(0,0,0,0.4);cursor:pointer}
    .modal-backdrop{position:fixed;left:0;top:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:6}
    .modal{background:var(--surface);padding:14px;border-radius:12px;max-width:820px;width:94%;box-shadow:0 8px 30px rgba(0,0,0,0.6);color:var(--text);position:relative}
    .modal .close{position:absolute;right:18px;top:18px;background:transparent;border:0;color:var(--muted);cursor:pointer}
    .debug{position:fixed;left:10px;bottom:80px;background:#fffb;color:#000;padding:8px;border-radius:6px;z-index:6;font-size:13px}
    .toggle{width:42px;height:26px;background:rgba(255,255,255,0.06);border-radius:999px;display:inline-flex;align-items:center;padding:4px;cursor:pointer}
    .toggle.on{background:rgba(var(--accent-rgb),0.22)}
    .toggle .dot{width:18px;height:18px;background:white;border-radius:50%;transform:translateX(0);transition:transform .18s}
    .toggle.on .dot{transform:translateX(16px)}
    .badge{background:rgba(255,255,255,0.04);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
    .skeleton{height:14px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.04));border-radius:6px}
    a{color:inherit}
  </style>
</head>
<body>
  <canvas id="bgCanvas"></canvas>
  <div class="app" id="app">
    <header>
      <div class="title-row">
        <div>
          <h1>Моя лента</h1>
          <div class="user" id="userInfo">Загрузка…</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="btnClose" class="btn ghost" title="Закрыть приложение">✖ Закрыть</button>
        </div>
      </div>
    </header>
    <main>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
        <input id="inputFeed" placeholder="rss:https://example.com/feed.xml или https://api.example.com/news.json" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)" />
        <button id="btnLoad" class="btn">Загрузить</button>
      </div>
      <div id="news" class="news-list"></div>
    </main>

    <div class="bottom-bar">
      <button id="btnToggleTheme" class="btn ghost">Тема</button>
      <label style="display:flex;gap:8px;align-items:center;color:var(--muted)">
        <div>Фон</div>
        <div id="bgToggle" class="toggle"><div class="dot"></div></div>
      </label>
      <div style="width:12px"></div>
      <div class="badge" id="statusBadge">—</div>
    </div>

    <button id="fabTranslate" class="fab-translate">Перевести всё</button>
  </div>

  <template id="cardTpl">
    <div class="card">
      <h4 class="ttl"></h4>
      <p class="desc"></p>
      <div class="meta">
        <div class="source"></div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="badge trBadge" style="display:none">TR</div>
          <button class="btn btnFav">★</button>
        </div>
      </div>
    </div>
  </template>

  <div id="modalRoot" style="display:none"></div>

  <script>
    // Minimal Telegram.WebApp shim for local testing
    window.Telegram = window.Telegram || { WebApp: { initData: null, initDataUnsafe: {}, platform: 'web' }};

    // LocalStorage keys
    const LS_FAV = 'tg_minapp_fav_v1';
    const LS_LAST = 'tg_minapp_last_v1';
    const LS_BG = 'tg_minapp_bg_anim_v1';
    const LS_THEME = 'tg_minapp_theme_override';
    const LS_TR = 'tg_minapp_tr_v1';

    // Config: change to your feed. Supports 'rss:<URL>' or 'https://.../json'
    let fetchUrl = 'rss:https://rss.nytimes.com/services/xml/rss/nyt/World.xml';

    // Small mock fallback
    const BASE_NEWS = [{id:'m1',title:'Пример новости',summary:'Короткое описание',link:'#',source:'Пример'}];

    let news = [];
    let isLoading = false;
    let favs = new Set(JSON.parse(localStorage.getItem(LS_FAV)||'[]'));
    let translateCache = JSON.parse(localStorage.getItem(LS_TR)||'{}');
    let translateQueue = [];
    let isProcessingQueue = false;

    const $ = (sel,root=document)=>root.querySelector(sel);
    const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));

    // Utilities
    function saveFavs(){ localStorage.setItem(LS_FAV, JSON.stringify(Array.from(favs))); }
    function saveTranslateCache(){ localStorage.setItem(LS_TR, JSON.stringify(translateCache)); }
    function setStatus(text){ $('#statusBadge').textContent = text; }

    // Fetch helpers
    async function fetchWithTimeout(url, opts={}, ms=12000){
      const controller = new AbortController();
      const id = setTimeout(()=>controller.abort(), ms);
      try{ const res = await fetch(url, {...opts, signal:controller.signal}); clearTimeout(id); return res; } catch(e){ clearTimeout(id); throw e; }
    }

    async function fetchRssViaAllOrigins(rssUrl){
      // Try a few public CORS proxies in order to improve success rate in browsers.
      const proxies = [
        { url: url => 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url), type: 'text' },
        { url: url => 'https://api.allorigins.win/get?url=' + encodeURIComponent(url), type: 'json' }
      ];
      let lastErr = null;
      for(const p of proxies){
        try{
          setStatus('Прокси: ' + (p.type) + ' — загрузка...');
          const res = await fetchWithTimeout(p.url(rssUrl), {}, 12000);
          if(!res.ok) throw new Error('proxy returned ' + res.status);
          let txt = null;
          if(p.type === 'json'){
            const j = await res.json(); txt = j && (j.contents || j.contents_text || j.contents_html) ? (j.contents || j.contents_text || j.contents_html) : JSON.stringify(j);
          } else {
            txt = await res.text();
          }
          const doc = new DOMParser().parseFromString(txt, 'application/xml');
          const items = Array.from(doc.querySelectorAll('item,entry'));
          if(!items.length) throw new Error('no items parsed from RSS');
          setStatus('Прокси успешен');
          return items.map((it,i)=>({
            id: 'rss-' + (it.querySelector('guid')?.textContent || i + '-' + (it.querySelector('title')?.textContent||'')),
            title: it.querySelector('title')?.textContent || it.querySelector('title')?.textContent || 'Без названия',
            summary: it.querySelector('description')?.textContent || it.querySelector('summary')?.textContent || '',
            link: it.querySelector('link')?.textContent || it.querySelector('id')?.textContent || '#',
            source: doc.querySelector('channel > title')?.textContent || 'RSS'
          }));
        }catch(err){
          console.warn('fetchRssViaAllOrigins proxy failed:', p, err);
          lastErr = err;
          // try next proxy
        }
      }
      // If all proxies failed, surface a clear error
      setStatus('Ошибка загрузки RSS (прокси недоступны)');
      throw lastErr || new Error('all proxies failed');
    }

    async function loadNews(url){
      isLoading = true; renderNews();
      setStatus('Загрузка...');
      let items = [];
      try{
        if(!url) url = fetchUrl;
        if(url.startsWith('rss:')){
          const r = url.slice(4);
          items = await fetchRssViaAllOrigins(r);
        } else {
          const res = await fetchWithTimeout(url, {}, 12000);
          items = await res.json();
          // normalize if coming as {items:[]}
          if(Array.isArray(items.items)) items = items.items;
          items = items.map((it,i)=>({ id: it.id || it.guid || 'j-' + i, title: it.title || it.name || 'Без названия', summary: it.summary || it.description || it.excerpt || '', link: it.url || it.link || '#', source: it.source || it.feed || 'JSON' }));
        }
        news = items.length ? items : BASE_NEWS;
        localStorage.setItem(LS_LAST, JSON.stringify(news));
        setStatus('Готово');
      } catch(err){
        console.error('loadNews', err);
        setStatus('Ошибка, используем кэш');
        const cached = JSON.parse(localStorage.getItem(LS_LAST) || 'null');
        news = cached && cached.length ? cached : BASE_NEWS;
      } finally{
        isLoading = false; renderNews();
        // enqueue translations for items that don't have cache
        news.forEach(it=>{ if(!translateCache[it.id]) enqueueTranslate(it.id, it.title + '\n\n' + (it.summary||'')); });
      }
    }

    // Render
    function renderNews(){
      const root = $('#news'); root.innerHTML = '';
      if(isLoading){
        for(let i=0;i<4;i++){
          const s = document.createElement('div'); s.className='card'; s.innerHTML='<div class="skeleton" style="width:60%"></div><div style="height:8px"></div><div class="skeleton" style="width:90%"></div>'; root.appendChild(s);
        }
        return;
      }
      news.forEach(it=>{
        const tpl = document.getElementById('cardTpl');
        const node = tpl.content.firstElementChild.cloneNode(true);
        node.querySelector('.ttl').textContent = it.title;
        node.querySelector('.desc').textContent = it.summary ? (it.summary.replace(/<[^>]+>/g,'').slice(0,220)) : '';
        node.querySelector('.source').textContent = it.source || '';
        const favBtn = node.querySelector('.btnFav');
        favBtn.textContent = favs.has(it.id) ? '★' : '☆';
        favBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); toggleFav(it.id); favBtn.textContent = favs.has(it.id) ? '★' : '☆'; });

        const trBadge = node.querySelector('.trBadge');
        if(translateCache[it.id]){ trBadge.style.display='inline-block'; }

        node.addEventListener('click', (ev)=>{ if(ev.ctrlKey||ev.metaKey){ window.open(it.link,'_blank'); } else openDetail(it); });
        root.appendChild(node);
      });
    }

    // Modal
    function openDetail(it){
      const root = $('#modalRoot'); root.style.display = 'flex'; root.innerHTML = '';
      const back = document.createElement('div'); back.className='modal-backdrop';
      const modal = document.createElement('div'); modal.className='modal';
      modal.innerHTML = `<button class="close">✖</button><h3>${escapeHtml(it.title)}</h3><div style="color:var(--muted);font-size:13px;margin-top:8px" id="modalSummary">${escapeHtml(it.summary||'')}</div><div style="margin-top:12px;display:flex;gap:8px"><a id="openLink" class="btn" target="_blank">Открыть</a><button id="doTranslate" class="btn ghost">Перевести</button><button id="toggleOrig" class="btn ghost">Оригинал</button></div>`;
      back.appendChild(modal); root.appendChild(back);
      back.addEventListener('click',(e)=>{ if(e.target===back) closeDetail(); });
      modal.querySelector('.close').addEventListener('click',closeDetail);
      const openLink = modal.querySelector('#openLink'); openLink.href = it.link; openLink.textContent = 'Открыть источник';

      const doTranslate = modal.querySelector('#doTranslate');
      const toggleOrig = modal.querySelector('#toggleOrig');
      const showTranslated = ()=>{ const t = translateCache[it.id]; if(t){ modal.querySelector('#modalSummary').textContent = t; } };
      if(translateCache[it.id]) showTranslated();
      doTranslate.addEventListener('click', async ()=>{
        setStatus('Перевод...');
        const t = await translateTextQueued(it.id, it.title + '\n\n' + (it.summary||''));
        if(t) { translateCache[it.id]=t; saveTranslateCache(); showTranslated(); updateCardTranslation(it.id,true); setStatus('Переведено'); }
        else { setStatus('Не удалось перевести'); window.open(googleTranslateUrl(it.title + '\n\n' + (it.summary||''))); }
      });
      toggleOrig.addEventListener('click', ()=>{ modal.querySelector('#modalSummary').textContent = it.summary||''; });
    }
    function closeDetail(){ const root = $('#modalRoot'); root.style.display='none'; root.innerHTML=''; }

    function updateCardTranslation(id, translated){ // marks badges in list
      $$('#news .card').forEach(card=>{
        const ttl = card.querySelector('.ttl').textContent;
        // we don't keep id on card nodes; match by title as fallback
        if(translateCache[id] && (ttl && news.find(n=>n.title===ttl && n.id===id))){ const b = card.querySelector('.trBadge'); if(b) b.style.display='inline-block'; }
      });
    }

    // Fav
    function toggleFav(id){ if(favs.has(id)) { favs.delete(id); } else { favs.add(id); } saveFavs(); }

    // Translation: Queue + cache + worker
    function enqueueTranslate(id, text){ if(translateCache[id]) return; translateQueue.push({id,text}); processTranslateQueue(); }

    async function processTranslateQueue(){
      if(isProcessingQueue) return; isProcessingQueue = true;
      while(translateQueue.length){
        const job = translateQueue.shift(); try{
          setStatus('Перевод (фон): ' + (news.find(n=>n.id===job.id)?.title||job.id).slice(0,30));
          const t = await translateTextLibre(job.text);
          if(t){ translateCache[job.id]=t; saveTranslateCache(); updateCardTranslation(job.id,true); }
        } catch(e){ console.warn('translate queue item failed', e); }
        // small pause
        await new Promise(r=>setTimeout(r, 600));
      }
      isProcessingQueue = false; setStatus('Готово');
    }

    async function translateTextQueued(id, text){ // immediate request via same API but returns result
      try{ const res = await translateTextLibre(text); if(res){ translateCache[id]=res; saveTranslateCache(); return res; } } catch(e){ console.warn(e); } return null; }

    async function translateTextLibre(text){
      // Use libretranslate public endpoint (may be rate-limited). You can replace with your own service.
      try{
        const resp = await fetchWithTimeout('https://libretranslate.de/translate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ q: text, source: 'auto', target: 'ru', format: 'text' }) }, 10000);
        if(!resp.ok) throw new Error('Bad status');
        const data = await resp.json(); return data.translatedText;
      } catch(err){ console.warn('libre translate failed', err); return null; }
    }
    function googleTranslateUrl(text){ return 'https://translate.google.com/?sl=auto&tl=ru&text=' + encodeURIComponent(text) + '&op=translate'; }

    // Simple escaping
    function escapeHtml(s){ if(!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // Canvas background (light-weight)
    const canvas = document.getElementById('bgCanvas'); const ctx = canvas.getContext('2d'); let stars = [];
    function resizeCanvas(){ canvas.width = innerWidth; canvas.height = innerHeight; }
    function createStars(){ stars = []; const count = Math.round((innerWidth*innerHeight)/70000); for(let i=0;i<count;i++){ stars.push({x:Math.random()*innerWidth,y:Math.random()*innerHeight,r:Math.random()*1.2+0.2,a:Math.random()*0.8+0.2,v:Math.random()*0.2-0.05}); } }
    function drawBg(){ ctx.clearRect(0,0,canvas.width,canvas.height); for(const s of stars){ s.x += s.v; if(s.x<0) s.x = canvas.width; if(s.x>canvas.width) s.x = 0; ctx.globalAlpha = s.a; ctx.fillStyle = '#7fb2ff'; ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill(); } ctx.globalAlpha = 1; requestAnimationFrame(drawBg); }

    // Theme & UI init
    function applyTheme(){ const saved = localStorage.getItem(LS_THEME); if(saved==='dark') { document.documentElement.style.setProperty('--bg','#071022'); } else if(saved==='light'){ document.documentElement.style.setProperty('--bg','#f6f7fb'); document.documentElement.style.setProperty('--text','#071022'); } }

    // Bind UI
    document.getElementById('btnLoad').addEventListener('click', ()=>{ const v = document.getElementById('inputFeed').value.trim(); if(v) { fetchUrl = v; loadNews(fetchUrl); } else loadNews(); });
    document.getElementById('btnClose').addEventListener('click', ()=>{ if(window.Telegram && Telegram.WebApp && Telegram.WebApp.close) Telegram.WebApp.close(); else alert('Закрыть (имитация)'); });
    document.getElementById('btnToggleTheme').addEventListener('click', ()=>{ const cur = localStorage.getItem(LS_THEME); const next = cur==='dark'?'light':'dark'; localStorage.setItem(LS_THEME,next); applyTheme(); });
    document.getElementById('bgToggle').addEventListener('click', ()=>{ const cur = localStorage.getItem(LS_BG)==='1'; localStorage.setItem(LS_BG, cur ? '0' : '1'); updateBgToggle(); });
    document.getElementById('fabTranslate').addEventListener('click', ()=>{ news.forEach(it=>enqueueTranslate(it.id, it.title + '\n\n' + (it.summary||''))); processTranslateQueue(); setStatus('Очередь отправлена'); });

    function updateBgToggle(){ const on = localStorage.getItem(LS_BG)!=='0'; const el = document.getElementById('bgToggle'); el.classList.toggle('on', on); if(on){ resizeCanvas(); createStars(); drawBg(); } }

    // Boot
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('load', ()=>{
      applyTheme();
      document.getElementById('inputFeed').value = fetchUrl;
      // restore cached data
      try{ const cached = JSON.parse(localStorage.getItem(LS_LAST)||'null'); if(cached && cached.length){ news = cached; } }catch(e){}
      try{ favs = new Set(JSON.parse(localStorage.getItem(LS_FAV)||'[]')); }catch(e){ favs = new Set(); }
      translateCache = JSON.parse(localStorage.getItem(LS_TR)||'{}');
      renderNews(); updateBgToggle(); loadNews();
    });

    // Global error handlers for debugging
    window.addEventListener('error', (e)=>{ console.error('Global error', e.error||e); });
    window.addEventListener('unhandledrejection', (e)=>{ console.error('Unhandled rejection', e.reason); });

  </script>
</body>
</html>