<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Telegram MiniApp — Моя лента</title>
  <style>
    :root{
      --bg:#071022; --surface:#081426; --text:#e6eef8; --muted:#9fb3d6; --accent:#2a8cff;
      --accent-rgb:42,140,255; --pill-bg:rgba(255,255,255,0.04); --btn-alpha:0.12
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    canvas#bgCanvas{position:fixed;left:0;top:0;right:0;bottom:0;z-index:0;pointer-events:none}
  .app{position:relative;z-index:2;max-width:960px;margin:0 auto;padding-top:120px;padding-bottom:80px}
  /* make header fixed so it stays visible in Telegram WebView */
  header{position:fixed;top:0;left:0;right:0;z-index:60;background:linear-gradient(180deg, rgba(6,10,20,0.98), rgba(6,10,20,0.9));padding:14px}
  main{height:calc(100vh - 120px - 80px);overflow:auto}
    .title-row{display:flex;align-items:center;justify-content:space-between}
    h1{font-size:18px;margin:0}
    .user{color:var(--muted);font-size:13px;margin-top:6px}
    main{padding:12px 18px 110px}
    .news-list{display:flex;flex-direction:column;gap:10px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:10px;padding:12px;cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
    .card h4{margin:0 0 6px 0}
    .card p{margin:0;color:var(--muted);font-size:13px}
    .meta{display:flex;justify-content:space-between;margin-top:8px;font-size:12px;color:var(--muted)}
  /* fixed bottom bar */
  .bottom-bar{position:fixed;left:0;right:0;bottom:0;background:var(--surface);padding:10px 12px;display:flex;justify-content:center;z-index:50;border-top:1px solid rgba(255,255,255,0.03)}
    .btn{background:rgba(var(--accent-rgb),var(--btn-alpha));border:0;padding:8px 12px;border-radius:8px;color:var(--text);cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
  /* removed global translate FAB */
    .modal-backdrop{position:fixed;left:0;top:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:6}
    .modal{background:var(--surface);padding:14px;border-radius:12px;max-width:820px;width:94%;box-shadow:0 8px 30px rgba(0,0,0,0.6);color:var(--text);position:relative}
    .modal .close{position:absolute;right:18px;top:18px;background:transparent;border:0;color:var(--muted);cursor:pointer}
    .debug{position:fixed;left:10px;bottom:80px;background:#fffb;color:#000;padding:8px;border-radius:6px;z-index:6;font-size:13px}
    .toggle{width:42px;height:26px;background:rgba(255,255,255,0.06);border-radius:999px;display:inline-flex;align-items:center;padding:4px;cursor:pointer}
    .toggle.on{background:rgba(var(--accent-rgb),0.22)}
    .toggle .dot{width:18px;height:18px;background:white;border-radius:50%;transform:translateX(0);transition:transform .18s}
    .toggle.on .dot{transform:translateX(16px)}
    .badge{background:rgba(255,255,255,0.04);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
    .skeleton{height:14px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.04));border-radius:6px}
    /* Source selector */
    .source-select{background:var(--surface);color:var(--text);border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:8px;font-size:14px}
    a{color:inherit}
  </style>
</head>
<body>
  <canvas id="bgCanvas"></canvas>
  <div class="app" id="app">
    <header>
      <div class="title-row">
        <div>
          <h1>Моя лента</h1>
          <div class="user" id="userInfo">Загрузка…</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="btnClose" class="btn ghost" title="Закрыть приложение">✖ Закрыть</button>
        </div>
      </div>
      <!-- Source selector (populated by JS) -->
      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <select id="sourceSelect" class="source-select" aria-label="Выбор источника"></select>
      </div>
    </header>
    <main>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
        <input id="inputFeed" placeholder="rss:https://example.com/feed.xml или https://api.example.com/news.json" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)" />
        <button id="btnLoad" class="btn">Загрузить</button>
      </div>
      <div id="news" class="news-list"></div>
    </main>

    <div class="bottom-bar">
      <button id="btnLoadMore" class="btn">Загрузить ещё</button>
    </div>
  </div>

  <template id="cardTpl">
    <div class="card">
      <h4 class="ttl"></h4>
      <p class="desc"></p>
      <div class="meta">
        <div class="source"></div>
        <div style="display:flex;gap:8px;align-items:center">
          <!-- translation badge removed -->
          <button class="btn btnFav">★</button>
        </div>
      </div>
    </div>
  </template>

  <div id="modalRoot" style="display:none"></div>

  <script>
    // Minimal Telegram.WebApp shim for local testing
    window.Telegram = window.Telegram || { WebApp: { initData: null, initDataUnsafe: {}, platform: 'web' }};

  // LocalStorage keys
  const LS_FAV = 'tg_minapp_fav_v1';
  const LS_LAST = 'tg_minapp_last_v1';
  const LS_BG = 'tg_minapp_bg_anim_v1';
  const LS_THEME = 'tg_minapp_theme_override';

    // Config: change to your feed. Supports 'rss:<URL>' or 'https://.../json'
    let fetchUrl = 'rss:https://rss.nytimes.com/services/xml/rss/nyt/World.xml';

    // Selected source storage
    const LS_SRC = 'tg_minapp_src_v1';

    // Available sources (id, name, url). URLs are prefixed with 'rss:' when they are RSS feeds.
    const SOURCES = [
      {id:'bbc', name:'BBC News', url:'rss:https://feeds.bbci.co.uk/news/rss.xml'},
      {id:'cnn', name:'CNN', url:'rss:http://rss.cnn.com/rss/edition.rss'},
      {id:'guardian', name:'The Guardian', url:'rss:https://www.theguardian.com/world/rss'},
      {id:'reuters', name:'Reuters', url:'rss:https://www.reuters.com/tools/rss'},
      {id:'aljazeera', name:'Al Jazeera', url:'rss:https://www.aljazeera.com/xml/rss/all.xml'},
      {id:'bloomberg', name:'Bloomberg', url:'rss:https://www.bloomberg.com/feed/podcast/etf.xml'},
      {id:'techcrunch', name:'TechCrunch', url:'rss:https://techcrunch.com/feed/'},
      {id:'verge', name:'The Verge', url:'rss:https://www.theverge.com/rss/index.xml'},
      {id:'hn', name:'Hacker News', url:'rss:https://hnrss.org/frontpage'},
      {id:'coindesk', name:'CoinDesk', url:'rss:https://www.coindesk.com/arc/outboundfeeds/rss/'},
      {id:'cointelegraph', name:'CoinTelegraph', url:'rss:https://cointelegraph.com/rss'},
      {id:'ft', name:'Financial Times', url:'rss:https://www.ft.com/?format=rss'},
      {id:'nytimes', name:'The New York Times', url:'rss:https://rss.nytimes.com/services/xml/rss/nyt/World.xml'},
      {id:'ap', name:'Associated Press', url:'rss:https://apnews.com/hub/ap-top-news?outputType=RSS'},
      {id:'npr', name:'NPR', url:'rss:https://feeds.npr.org/1001/rss.xml'},
      {id:'wired', name:'Wired', url:'rss:https://www.wired.com/feed/rss'},
      {id:'arstechnica', name:'Ars Technica', url:'rss:http://feeds.arstechnica.com/arstechnica/index'},
      {id:'engadget', name:'Engadget', url:'rss:https://www.engadget.com/rss.xml'},
      {id:'euronews', name:'Euronews', url:'rss:https://www.euronews.com/rss?level=2&name=home'},
      {id:'dw', name:'DW', url:'rss:https://rss.dw.com/rdf/rss-en-all'},
      {id:'guardian-tech', name:'The Guardian - Tech', url:'rss:https://www.theguardian.com/uk/technology/rss'},
      {id:'techmcr', name:'Techmeme', url:'rss:https://www.techmeme.com/feed.xml'},
      {id:'eng', name:'Engage (examples)', url:'rss:https://feeds.feedburner.com/TechCrunch/'},
      {id:'bbc-world', name:'BBC World', url:'rss:https://feeds.bbci.co.uk/news/world/rss.xml'}
    ];

    // Populate the source selector and wire persistence
    function loadSources(){
      const sel = document.getElementById('sourceSelect'); if(!sel) return;
      sel.innerHTML = '';
      const placeholder = document.createElement('option'); placeholder.value = ''; placeholder.textContent = 'Выберите источник...'; sel.appendChild(placeholder);
      SOURCES.forEach(s=>{ const o = document.createElement('option'); o.value = s.id; o.textContent = s.name; sel.appendChild(o); });
      // restore selection
      const saved = localStorage.getItem(LS_SRC);
      if(saved){ sel.value = saved; const src = SOURCES.find(x=>x.id===saved); if(src){ fetchUrl = src.url; document.getElementById('inputFeed').value = fetchUrl; }}
      sel.addEventListener('change', (e)=>{
        const id = e.target.value; if(!id) return;
        localStorage.setItem(LS_SRC, id);
        const src = SOURCES.find(x=>x.id===id);
        if(src){
          // clear current list immediately for UX, then load new source
          news = []; displayedCount = 0; renderNews();
          fetchUrl = src.url; document.getElementById('inputFeed').value = fetchUrl; loadNews(src.url);
        }
      });
  // selection change already triggers load; no top reload button present
    }

    // Load news by source id (modular entrypoint)
    function loadNewsById(sourceId){
      const src = SOURCES.find(s=>s.id === sourceId);
      if(!src){ setStatus('Источник не найден'); return; }
      try{ localStorage.setItem(LS_SRC, sourceId); fetchUrl = src.url; document.getElementById('inputFeed').value = fetchUrl; news = []; displayedCount = 0; renderNews(); loadNews(src.url); }
      catch(e){ console.error('loadNewsById', e); setStatus('Ошибка при загрузке источника'); }
    }

  // Small mock fallback
  const BASE_NEWS = [{id:'m1',title:'Пример новости',summary:'Короткое описание',link:'#',source:'Пример'}];

  let news = [];
  let isLoading = false;
  let favs = new Set(JSON.parse(localStorage.getItem(LS_FAV)||'[]'));
  // pagination / UI state
  const PAGE_SIZE = 10;
  let displayedCount = 0; // how many items currently rendered

  const $ = (sel,root=document)=>root.querySelector(sel);
  const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));

    // Utilities
  function saveFavs(){ localStorage.setItem(LS_FAV, JSON.stringify(Array.from(favs))); }
  // lightweight status: log + show debug banner if exists
  function setStatus(text){ try{ const dbg = document.getElementById('debugBanner'); if(dbg){ dbg.style.display='block'; dbg.textContent = text; setTimeout(()=>{ dbg.style.display='none'; }, 2500); } }catch(e){} console.log('[status]', text); }

    // Fetch helpers
    async function fetchWithTimeout(url, opts={}, ms=12000){
      const controller = new AbortController();
      const id = setTimeout(()=>controller.abort(), ms);
      try{ const res = await fetch(url, {...opts, signal:controller.signal}); clearTimeout(id); return res; } catch(e){ clearTimeout(id); throw e; }
    }

    async function fetchRssViaAllOrigins(rssUrl){
      // Try a few public CORS proxies in order to improve success rate in browsers.
      const proxies = [
        { url: url => 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url), type: 'text' },
        { url: url => 'https://api.allorigins.win/get?url=' + encodeURIComponent(url), type: 'json' }
      ];
      let lastErr = null;
      for(const p of proxies){
        try{
          setStatus('Прокси: ' + (p.type) + ' — загрузка...');
          const res = await fetchWithTimeout(p.url(rssUrl), {}, 12000);
          if(!res.ok) throw new Error('proxy returned ' + res.status);
          let txt = null;
          if(p.type === 'json'){
            const j = await res.json(); txt = j && (j.contents || j.contents_text || j.contents_html) ? (j.contents || j.contents_text || j.contents_html) : JSON.stringify(j);
          } else {
            txt = await res.text();
          }
          const doc = new DOMParser().parseFromString(txt, 'application/xml');
          const items = Array.from(doc.querySelectorAll('item,entry'));
          if(!items.length) throw new Error('no items parsed from RSS');
          setStatus('Прокси успешен');
          return items.map((it,i)=>({
            id: 'rss-' + (it.querySelector('guid')?.textContent || i + '-' + (it.querySelector('title')?.textContent||'')),
            title: it.querySelector('title')?.textContent || it.querySelector('title')?.textContent || 'Без названия',
            summary: it.querySelector('description')?.textContent || it.querySelector('summary')?.textContent || '',
            link: it.querySelector('link')?.textContent || it.querySelector('id')?.textContent || '#',
            source: doc.querySelector('channel > title')?.textContent || 'RSS'
          }));
        }catch(err){
          console.warn('fetchRssViaAllOrigins proxy failed:', p, err);
          lastErr = err;
          // try next proxy
        }
      }
      // If all proxies failed, surface a clear error
      setStatus('Ошибка загрузки RSS (прокси недоступны)');
      throw lastErr || new Error('all proxies failed');
    }

    async function loadNews(url){
      isLoading = true; renderNews();
      setStatus('Загрузка...');
      let items = [];
      try{
        if(!url) url = fetchUrl;
        if(url.startsWith('rss:')){
          const r = url.slice(4);
          items = await fetchRssViaAllOrigins(r);
        } else {
          const res = await fetchWithTimeout(url, {}, 12000);
          items = await res.json();
          // normalize if coming as {items:[]}
          if(Array.isArray(items.items)) items = items.items;
          items = items.map((it,i)=>({ id: it.id || it.guid || 'j-' + i, title: it.title || it.name || 'Без названия', summary: it.summary || it.description || it.excerpt || '', link: it.url || it.link || '#', source: it.source || it.feed || 'JSON' }));
        }
        news = items.length ? items : BASE_NEWS;
        // reset pagination
        displayedCount = Math.min(PAGE_SIZE, news.length);
        localStorage.setItem(LS_LAST, JSON.stringify(news));
        setStatus('Готово');
      } catch(err){
        console.error('loadNews', err);
        setStatus('Ошибка, используем кэш');
        const cached = JSON.parse(localStorage.getItem(LS_LAST) || 'null');
        news = cached && cached.length ? cached : BASE_NEWS;
        displayedCount = Math.min(PAGE_SIZE, news.length);
      } finally{
        isLoading = false; renderNews();
      }
    }

    // Render
    function renderNews(){
      const root = $('#news'); root.innerHTML = '';
      if(isLoading){
        for(let i=0;i<4;i++){
          const s = document.createElement('div'); s.className='card'; s.innerHTML='<div class="skeleton" style="width:60%"></div><div style="height:8px"></div><div class="skeleton" style="width:90%"></div>'; root.appendChild(s);
        }
        return;
      }
      // render only up to displayedCount for 'Load more' pagination
      const list = news.slice(0, displayedCount);
      const frag = document.createDocumentFragment();
      list.forEach(it=>{
        const tpl = document.getElementById('cardTpl');
        const node = tpl.content.firstElementChild.cloneNode(true);
        node.querySelector('.ttl').textContent = it.title;
        node.querySelector('.desc').textContent = it.summary ? (it.summary.replace(/<[^>]+>/g,'').slice(0,220)) : '';
        node.querySelector('.source').textContent = it.source || '';
        const favBtn = node.querySelector('.btnFav');
        favBtn.textContent = favs.has(it.id) ? '★' : '☆';
        favBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); toggleFav(it.id); favBtn.textContent = favs.has(it.id) ? '★' : '☆'; });
        node.addEventListener('click', (ev)=>{ if(ev.ctrlKey||ev.metaKey){ window.open(it.link,'_blank'); } else openDetail(it); });
        frag.appendChild(node);
      });
      root.appendChild(frag);
      // toggle Load more button
      const moreBtn = document.getElementById('btnLoadMore');
      if(moreBtn) moreBtn.disabled = displayedCount >= news.length;
    }

    // Modal
    function openDetail(it){
      const root = $('#modalRoot'); root.style.display = 'flex'; root.innerHTML = '';
      const back = document.createElement('div'); back.className='modal-backdrop';
      const modal = document.createElement('div'); modal.className='modal';
  modal.innerHTML = `<button class="close">✖</button><h3>${escapeHtml(it.title)}</h3><div style="color:var(--muted);font-size:13px;margin-top:8px" id="modalSummary">${escapeHtml(it.summary||'')}</div><div style="margin-top:12px;display:flex;gap:8px"><a id="openLink" class="btn" target="_blank">Открыть</a></div>`;
    back.appendChild(modal); root.appendChild(back);
    back.addEventListener('click',(e)=>{ if(e.target===back) closeDetail(); });
    modal.querySelector('.close').addEventListener('click',closeDetail);
    const openLink = modal.querySelector('#openLink'); openLink.href = it.link; openLink.textContent = 'Открыть источник';
    }
    function closeDetail(){ const root = $('#modalRoot'); root.style.display='none'; root.innerHTML=''; }

    // removed translation badge updater (translations disabled)

    // Fav
    function toggleFav(id){ if(favs.has(id)) { favs.delete(id); } else { favs.add(id); } saveFavs(); }

    // Translations removed: no background translation or external translators are used.

    // Simple escaping
    function escapeHtml(s){ if(!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // Canvas background (light-weight)
    const canvas = document.getElementById('bgCanvas'); const ctx = canvas.getContext('2d'); let stars = [];
    function resizeCanvas(){ canvas.width = innerWidth; canvas.height = innerHeight; }
    function createStars(){ stars = []; const count = Math.round((innerWidth*innerHeight)/70000); for(let i=0;i<count;i++){ stars.push({x:Math.random()*innerWidth,y:Math.random()*innerHeight,r:Math.random()*1.2+0.2,a:Math.random()*0.8+0.2,v:Math.random()*0.2-0.05}); } }
    function drawBg(){ ctx.clearRect(0,0,canvas.width,canvas.height); for(const s of stars){ s.x += s.v; if(s.x<0) s.x = canvas.width; if(s.x>canvas.width) s.x = 0; ctx.globalAlpha = s.a; ctx.fillStyle = '#7fb2ff'; ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill(); } ctx.globalAlpha = 1; requestAnimationFrame(drawBg); }

    // Theme & UI init
    function applyTheme(){ const saved = localStorage.getItem(LS_THEME); if(saved==='dark') { document.documentElement.style.setProperty('--bg','#071022'); } else if(saved==='light'){ document.documentElement.style.setProperty('--bg','#f6f7fb'); document.documentElement.style.setProperty('--text','#071022'); } }

    // Bind UI
  document.getElementById('btnLoad').addEventListener('click', ()=>{ const v = document.getElementById('inputFeed').value.trim(); if(v) { fetchUrl = v; loadNews(fetchUrl); } else loadNews(); });
  document.getElementById('btnClose').addEventListener('click', ()=>{ if(window.Telegram && Telegram.WebApp && Telegram.WebApp.close) Telegram.WebApp.close(); else alert('Закрыть (имитация)'); });
  const themeBtn = document.getElementById('btnToggleTheme'); if(themeBtn) themeBtn.addEventListener('click', ()=>{ const cur = localStorage.getItem(LS_THEME); const next = cur==='dark'?'light':'dark'; localStorage.setItem(LS_THEME,next); applyTheme(); });
  const bgToggleBtn = document.getElementById('bgToggle'); if(bgToggleBtn) bgToggleBtn.addEventListener('click', ()=>{ const cur = localStorage.getItem(LS_BG)==='1'; localStorage.setItem(LS_BG, cur ? '0' : '1'); updateBgToggle(); });
  // Load more button
  const loadMoreBtn = document.getElementById('btnLoadMore'); if(loadMoreBtn){ loadMoreBtn.addEventListener('click', ()=>{ if(!news || !news.length) return; displayedCount = Math.min(news.length, displayedCount + PAGE_SIZE); renderNews(); }); }

    function updateBgToggle(){ const on = localStorage.getItem(LS_BG)!=='0'; const el = document.getElementById('bgToggle'); el.classList.toggle('on', on); if(on){ resizeCanvas(); createStars(); drawBg(); } }

    // Boot
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('load', ()=>{
      applyTheme();
      // populate source selector and restore selection
      try{ loadSources(); }catch(e){ console.warn('loadSources failed', e); }
      // restore cached data
      try{ const cached = JSON.parse(localStorage.getItem(LS_LAST)||'null'); if(cached && cached.length){ news = cached; } }catch(e){}
      try{ favs = new Set(JSON.parse(localStorage.getItem(LS_FAV)||'[]')); }catch(e){ favs = new Set(); }
      // if a saved source exists, load it; otherwise show default fetchUrl
      const savedSrc = localStorage.getItem(LS_SRC);
      if(savedSrc){ document.getElementById('inputFeed').value = (SOURCES.find(s=>s.id===savedSrc)||{}).url || fetchUrl; renderNews(); updateBgToggle(); loadNewsById(savedSrc); }
      else { document.getElementById('inputFeed').value = fetchUrl; renderNews(); updateBgToggle(); loadNews(); }
    });

    // Global error handlers for debugging
    window.addEventListener('error', (e)=>{ console.error('Global error', e.error||e); });
    window.addEventListener('unhandledrejection', (e)=>{ console.error('Unhandled rejection', e.reason); });

  </script>
</body>
</html>