<!doctype html>
<html lang="ru">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Telegram MiniApp - Моя лента</title>
  <style>
    :root {
      --bg: #0b1226;
      --surface: #0e1730;
      --surface-2: #101c38;
      --text: #eef2ff;
      --muted: #9fb0d0;
      --accent: #ff8a3d;
      --accent-2: #4cc9f0;
      --accent-rgb: 255, 138, 61;
      --border: rgba(255, 255, 255, 0.06);
      --pill-bg: rgba(255, 255, 255, 0.06);
      --btn-alpha: 0.16;
      --radius: 14px;
      --shadow: 0 16px 40px rgba(2, 8, 20, 0.45);
      --header-h: 168px;
      --bottom-h: 64px;
      --safe-bottom: env(safe-area-inset-bottom);
      --app-h: 100vh;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      font-family: "Space Grotesk", "IBM Plex Sans", "Segoe UI", sans-serif
    }

    body {
      background:
        radial-gradient(900px 520px at 10% -10%, rgba(255, 138, 61, 0.18), transparent 60%),
        radial-gradient(720px 400px at 90% 10%, rgba(76, 201, 240, 0.18), transparent 60%),
        linear-gradient(180deg, #080f22 0%, #0b1226 45%, #0b1226 100%);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      height: var(--app-h);
    }

    @supports (height: 100dvh) {
      :root {
        --app-h: 100dvh
      }
    }

    canvas#bgCanvas {
      position: fixed;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      z-index: 0;
      pointer-events: none;
      opacity: 0.4
    }

    .app {
      position: relative;
      z-index: 2;
      max-width: 1024px;
      margin: 0 auto;
      padding-top: calc(var(--header-h) + 14px);
      padding-bottom: 0
    }

    /* make header fixed so it stays visible in Telegram WebView */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 60;
      background: linear-gradient(180deg, rgba(8, 13, 25, 0.98), rgba(8, 13, 25, 0.86));
      padding: 14px 18px 12px;
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(10px)
    }

    main {
      height: calc(var(--app-h) - var(--header-h) - var(--bottom-h) - var(--safe-bottom));
      overflow: auto;
      padding: 12px 18px calc(16px + var(--safe-bottom));
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain
    }

    .title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px
    }

    h1 {
      font-size: 20px;
      margin: 0;
      letter-spacing: 0.2px
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px
    }

    .logo {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      background: linear-gradient(140deg, var(--accent), var(--accent-2));
      display: grid;
      place-items: center;
      color: #081022;
      font-weight: 700
    }

    .user {
      color: var(--muted);
      font-size: 13px;
      margin-top: 4px
    }

    .toolbar {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 12px
    }

    .search-wrap {
      flex: 1;
      min-width: 180px;
      display: flex;
      gap: 8px
    }

    .input,
    .source-select {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 14px;
      outline: none
    }

    .input::placeholder {
      color: #7686a6
    }

    .source-select {
      min-width: 160px
    }

    .chip {
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      padding: 9px 12px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer
    }

    .chip.active {
      background: rgba(var(--accent-rgb), 0.18);
      border-color: rgba(var(--accent-rgb), 0.4)
    }

    .stats {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap
    }

    .stat-pill {
      background: var(--pill-bg);
      border: 1px solid var(--border);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted)
    }

    .status-pill {
      background: rgba(76, 201, 240, 0.14);
      border: 1px solid rgba(76, 201, 240, 0.32);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: #bdeaf7;
      opacity: 0;
      transition: opacity .2s
    }

    .status-pill.show {
      opacity: 1
    }

    .panel {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: var(--shadow)
    }

    .news-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 12px
    }

    .card {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.035), rgba(255, 255, 255, 0.01));
      border-radius: var(--radius);
      padding: 14px;
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.06);
      transition: transform .12s ease, border-color .2s ease
    }

    .card:hover {
      transform: translateY(-2px);
      border-color: rgba(255, 138, 61, 0.35)
    }

    .card h4 {
      margin: 0 0 6px 0;
      font-size: 15px;
      line-height: 1.3
    }

    .card {
      content-visibility: auto;
      contain-intrinsic-size: 120px;
      contain: content
    }

    .card p {
      margin: 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45
    }

    .desc {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden
    }

    .meta {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      align-items: center
    }

    .meta-left {
      display: flex;
      align-items: center;
      gap: 8px
    }

    .tag {
      background: rgba(255, 255, 255, 0.06);
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      color: var(--muted)
    }

    .time {
      color: #8da1c7
    }

    /* fixed bottom bar */
    .bottom-bar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(180deg, rgba(12, 20, 40, 0.92), rgba(12, 20, 40, 0.98));
      padding: 10px 12px;
      padding-bottom: calc(10px + var(--safe-bottom));
      display: flex;
      justify-content: center;
      z-index: 50;
      border-top: 1px solid var(--border)
    }

    .btn {
      background: rgba(var(--accent-rgb), var(--btn-alpha));
      border: 0;
      padding: 9px 12px;
      border-radius: 10px;
      color: var(--text);
      cursor: pointer;
      transition: transform .1s ease
    }

    .btn:active {
      transform: scale(0.98)
    }

    .btn.ghost {
      background: transparent;
      border: 1px solid var(--border)
    }

    .btn.small {
      padding: 8px 10px;
      font-size: 12px
    }

    .modal-backdrop {
      position: fixed;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.45);
      z-index: 6
    }

    .modal {
      background: var(--surface);
      padding: 18px;
      border-radius: 16px;
      max-width: 820px;
      width: 94%;
      max-height: calc(var(--app-h) * 0.92);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
      color: var(--text);
      position: relative;
      display: flex;
      flex-direction: column
    }

    .modal .close {
      position: absolute;
      right: 18px;
      top: 18px;
      background: transparent;
      border: 0;
      color: var(--muted);
      cursor: pointer;
      font-size: 22px;
      line-height: 1
    }

    .modal-body {
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      max-height: calc(var(--app-h) * 0.92 - 70px)
    }

    .modal-actions {
      position: sticky;
      bottom: 0;
      background: var(--surface);
      padding-top: 10px;
      margin-top: 12px;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      border-top: 1px solid var(--border)
    }

    .translate-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 12px;
      flex-wrap: wrap
    }

    .translate-output {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 13px
    }

    .lang-select {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 12px
    }

    .toggle {
      width: 44px;
      height: 26px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      padding: 4px;
      cursor: pointer;
      border: 1px solid var(--border)
    }

    .toggle.on {
      background: rgba(var(--accent-rgb), 0.28)
    }

    .toggle .dot {
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      transform: translateX(0);
      transition: transform .18s
    }

    .toggle.on .dot {
      transform: translateX(16px)
    }

    .badge {
      background: rgba(255, 255, 255, 0.04);
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted)
    }

    .skeleton {
      height: 14px;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.02));
      border-radius: 6px;
      animation: shimmer 1.3s infinite;
      background-size: 200px 100%
    }

    .empty {
      padding: 30px 16px;
      text-align: center;
      color: var(--muted)
    }

    .status-pill.error {
      background: rgba(255, 120, 120, 0.16);
      border-color: rgba(255, 120, 120, 0.35);
      color: #ffd0d0
    }

    a {
      color: inherit
    }

    @keyframes shimmer {
      0% {
        background-position: -120px 0
      }

      100% {
        background-position: 120px 0
      }
    }

    @media (max-width:720px) {
      :root {
        --header-h: 188px
      }

      .title-row {
        flex-direction: column;
        align-items: flex-start
      }

      .toolbar {
        align-items: stretch
      }

      .search-wrap {
        flex-direction: column
      }

      .bottom-bar {
        padding: 8px
      }
    }

    @media (max-width:520px) {
      :root {
        --header-h: 132px
      }

      header {
        padding: 10px 12px 8px
      }

      h1 {
        font-size: 16px
      }

      .user {
        font-size: 12px
      }

      .source-select {
        min-height: 36px;
        padding: 6px 8px
      }

      .btn,
      .source-select,
      .input {
        min-height: 44px
      }

      .toolbar,
      .search-wrap {
        gap: 10px
      }

      .panel .feed-row {
        gap: 10px
      }

      .feed-advanced {
        display: none
      }

      .feed-advanced.show {
        display: flex
      }
    }
  </style>
</head>

<body>
  <canvas id="bgCanvas"></canvas>
  <div class="app" id="app">
    <header>
      <div class="title-row">
        <div class="brand">
          <div class="logo">N</div>
          <div>
            <h1>Моя лента</h1>
            <div class="user" id="userInfo">Загрузка:</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center"></div>
      </div>
      <div class="toolbar">
        <div class="search-wrap">
          <input id="inputSearch" class="input" placeholder="Поиск по заголовкам и описанию" />
          <button id="btnClearSearch" class="btn small ghost" title="Очистить поиск">Очистить</button>
        </div>
        <select id="sourceSelect" class="source-select" aria-label="Выбор источника"></select>
        <button id="btnFavFilter" class="chip" aria-pressed="false">Только избранные</button>
        <div style="display:flex;gap:8px;align-items:center">
          <span class="badge">Фон</span>
          <button id="bgToggle" class="toggle" aria-label="Анимация фона"><span class="dot"></span></button>
        </div>
      </div>
      <div class="stats">
        <div id="statCount" class="stat-pill">0 новостей</div>
        <div id="statSource" class="stat-pill">Источник: —</div>
        <div id="statusPill" class="status-pill">Загрузка...</div>
      </div>
    </header>
    <main>
      <div class="panel">
        <div class="feed-row" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="btnToggleAdvanced" class="btn ghost">⚙︎ Настройки</button>
          <div id="feedAdvanced" class="feed-advanced"
            style="display:flex;gap:8px;align-items:center;flex:1;min-width:200px">
            <input id="inputFeed" class="input"
              placeholder="rss:https://example.com/feed.xml или https://api.example.com/news.json"
              style="flex:1;min-width:200px" />
          </div>
          <button id="btnLoad" class="btn">Загрузить</button>
        </div>
      </div>
      <div id="news" class="news-list"></div>
      <div id="emptyState" class="empty" style="display:none">Пока ничего нет. Попробуйте выбрать другой источник или
        изменить поиск.</div>
    </main>

    <div class="bottom-bar">
      <button id="btnLoadMore" class="btn">Загрузить еще</button>
    </div>
  </div>

  <template id="cardTpl">
    <div class="card">
      <h4 class="ttl"></h4>
      <p class="desc"></p>
      <div class="meta">
        <div class="meta-left">
          <div class="source tag"></div>
          <div class="time"></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <!-- translation badge removed -->
          <button class="btn btnFav">☆</button>
        </div>
      </div>
    </div>
  </template>

  <div id="modalRoot" style="display:none"></div>

  <script>
    // Minimal Telegram.WebApp shim for local testing
    window.Telegram = window.Telegram || { WebApp: { initData: null, initDataUnsafe: {}, platform: 'web' } };

    // LocalStorage keys
    const LS_FAV = 'tg_minapp_fav_v1';
    const LS_LAST = 'tg_minapp_last_v1';
    const LS_BG = 'tg_minapp_bg_anim_v1';
    const LS_THEME = 'tg_minapp_theme_override';
    const LS_TRANSLATIONS = 'tg_translations_v1';
    const API_BASE = 'https://hidden-silence-1ec8.ilyxich4.workers.dev';
    const API_BASE_N = API_BASE.replace(/\/+$/, '');
    const RSS_ENDPOINT = API_BASE_N + '/rss';
    const TRANSLATE_ENDPOINT = API_BASE_N + '/translate';
    const LS_UI_ADVANCED = 'tg_minapp_ui_advanced';

    // Config: change to your feed. Supports 'rss:<URL>' or 'https://.../json'
    let fetchUrl = 'rss:https://rss.nytimes.com/services/xml/rss/nyt/World.xml';

    // Selected source storage
    const LS_SRC = 'tg_minapp_src_v1';

    // Available sources (id, name, url). URLs are prefixed with 'rss:' when they are RSS feeds.
    const SOURCES = [
      { id: 'bbc', name: 'BBC News', url: 'rss:https://feeds.bbci.co.uk/news/rss.xml' },
      { id: 'cnn', name: 'CNN', url: 'rss:http://rss.cnn.com/rss/edition.rss' },
      { id: 'guardian', name: 'The Guardian', url: 'rss:https://www.theguardian.com/world/rss' },
      { id: 'aljazeera', name: 'Al Jazeera', url: 'rss:https://www.aljazeera.com/xml/rss/all.xml' },
      { id: 'bloomberg', name: 'Bloomberg', url: 'rss:https://www.bloomberg.com/feed/podcast/etf.xml' },
      { id: 'techcrunch', name: 'TechCrunch', url: 'rss:https://techcrunch.com/feed/' },
      { id: 'verge', name: 'The Verge', url: 'rss:https://www.theverge.com/rss/index.xml' },
      { id: 'hn', name: 'Hacker News', url: 'rss:https://hnrss.org/frontpage' },
      { id: 'coindesk', name: 'CoinDesk', url: 'rss:https://www.coindesk.com/arc/outboundfeeds/rss/' },
      { id: 'cointelegraph', name: 'CoinTelegraph', url: 'rss:https://cointelegraph.com/rss' },
      { id: 'ft', name: 'Financial Times', url: 'rss:https://www.ft.com/?format=rss' },
      { id: 'nytimes', name: 'The New York Times', url: 'rss:https://rss.nytimes.com/services/xml/rss/nyt/World.xml' },
      { id: 'ap', name: 'Associated Press', url: 'rss:https://apnews.com/hub/ap-top-news?outputType=RSS' },
      { id: 'npr', name: 'NPR', url: 'rss:https://feeds.npr.org/1001/rss.xml' },
      { id: 'wired', name: 'Wired', url: 'rss:https://www.wired.com/feed/rss' },
      { id: 'arstechnica', name: 'Ars Technica', url: 'rss:http://feeds.arstechnica.com/arstechnica/index' },
      { id: 'engadget', name: 'Engadget', url: 'rss:https://www.engadget.com/rss.xml' },
      { id: 'euronews', name: 'Euronews', url: 'rss:https://www.euronews.com/rss?level=2&name=home' },
      { id: 'dw', name: 'DW', url: 'rss:https://rss.dw.com/rdf/rss-en-all' },
      { id: 'guardian-tech', name: 'The Guardian - Tech', url: 'rss:https://www.theguardian.com/uk/technology/rss' },
      { id: 'techmcr', name: 'Techmeme', url: 'rss:https://www.techmeme.com/feed.xml' },
      { id: 'eng', name: 'Engage (examples)', url: 'rss:https://feeds.feedburner.com/TechCrunch/' },
      { id: 'bbc-world', name: 'BBC World', url: 'rss:https://feeds.bbci.co.uk/news/world/rss.xml' }
    ];

    // Populate the source selector and wire persistence
    function loadSources() {
      const sel = document.getElementById('sourceSelect'); if (!sel) return;
      sel.innerHTML = '';
      const placeholder = document.createElement('option'); placeholder.value = ''; placeholder.textContent = 'Выберите источник...'; sel.appendChild(placeholder);
      SOURCES.forEach(s => { const o = document.createElement('option'); o.value = s.id; o.textContent = s.name; sel.appendChild(o); });
      // restore selection
      const saved = localStorage.getItem(LS_SRC);
      if (saved) { sel.value = saved; const src = SOURCES.find(x => x.id === saved); if (src) { fetchUrl = src.url; document.getElementById('inputFeed').value = fetchUrl; } }
      sel.addEventListener('change', (e) => {
        const id = e.target.value; if (!id) return;
        localStorage.setItem(LS_SRC, id);
        const src = SOURCES.find(x => x.id === id);
        if (src) {
          // clear current list immediately for UX, then load new source
          news = []; displayedCount = 0; renderNews();
          fetchUrl = src.url; document.getElementById('inputFeed').value = fetchUrl; loadNews(src.url);
        }
      });
      // selection change already triggers load; no top reload button present
    }

    // Load news by source id (modular entrypoint)
    function loadNewsById(sourceId) {
      const src = SOURCES.find(s => s.id === sourceId);
      if (!src) { setStatus('Источник не найден'); return; }
      try { localStorage.setItem(LS_SRC, sourceId); fetchUrl = src.url; document.getElementById('inputFeed').value = fetchUrl; news = []; displayedCount = 0; renderNews(); loadNews(src.url); }
      catch (e) { console.error('loadNewsById', e); setStatus('Ошибка при загрузке источника'); }
    }

    // Small mock fallback
    const BASE_NEWS = [{ id: 'm1', title: 'Пример новости', summary: 'Короткое описание', link: '#', source: 'Пример', date: new Date().toISOString() }];

    let news = [];
    let isLoading = false;
    let favs = new Set(JSON.parse(localStorage.getItem(LS_FAV) || '[]'));
    let favFilterOn = false;
    // pagination / UI state
    const PAGE_SIZE = 10;
    let displayedCount = 0; // how many items currently rendered

    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

    // Utilities
    function saveFavs() { localStorage.setItem(LS_FAV, JSON.stringify(Array.from(favs))); }
    // lightweight status: log + show status pill
    function setStatus(text, isError = false) {
      try {
        const pill = document.getElementById('statusPill');
        if (pill) {
          pill.textContent = text;
          pill.classList.toggle('error', !!isError);
          pill.classList.add('show');
          clearTimeout(pill._hideTimer);
          pill._hideTimer = setTimeout(() => pill.classList.remove('show'), isError ? 3600 : 2200);
        }
      } catch (e) { }
      console.log('[status]', text);
    }

    // Fetch helpers
    async function fetchWithTimeout(url, opts = {}, ms = 12000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), ms);
      try { const res = await fetch(url, { ...opts, signal: controller.signal }); clearTimeout(id); return res; } catch (e) { clearTimeout(id); throw e; }
    }

    async function fetchRssViaAllOrigins(rssUrl) {
      const apiUrl = `${RSS_ENDPOINT}?url=${encodeURIComponent(rssUrl)}`;
      setStatus('RSS: worker (loading)');
      const res = await fetchWithTimeout(apiUrl, {}, 20000);
      if (!res.ok) {
        console.warn('RSS worker non-OK', { apiUrl, rssUrl, status: res.status });
        setStatus(`RSS: worker (HTTP ${res.status})`, true);
        throw new Error(`RSS: worker HTTP ${res.status}`);
      }
      const data = await res.json();
      if (!data || !Array.isArray(data.items)) {
        console.warn('RSS worker invalid', { apiUrl, rssUrl, data });
        setStatus('RSS: worker (invalid)', true);
        throw new Error('RSS: worker invalid');
      }
      setStatus('RSS: worker OK');
      return data.items.map((it, i) => ({
        id: it.id || it.guid || 'rss-' + i,
        title: it.title || it.name || 'Без названия',
        summary: it.summary || it.description || it.excerpt || '',
        link: it.link || it.url || '#',
        source: it.source || it.feed || 'RSS',
        date: it.date || it.pubDate || it.published || ''
      }));
    }

    async function loadNews(url) {
      isLoading = true; renderNews();
      setStatus('Загрузка...');
      let items = [];
      try {
        if (!url) url = fetchUrl;
        if (url.startsWith('rss:')) {
          const r = url.slice(4);
          items = await fetchRssViaAllOrigins(r);
        } else {
          const res = await fetchWithTimeout(url, {}, 12000);
          if (!res.ok) {
            console.error('JSON non-OK', { url, status: res.status });
            throw new Error('JSON: HTTP ' + res.status);
          }
          const obj = await res.json();
          if (Array.isArray(obj)) items = obj;
          else if (obj && typeof obj === 'object') {
            items = obj.items || obj.articles || obj.data || obj.results || [];
          }
          if (!Array.isArray(items)) {
            console.error('JSON invalid shape', { url, obj });
            throw new Error('JSON: не найден массив items');
          }
          items = items.map((it, i) => ({
            id: it.id || it.guid || 'j-' + i,
            title: it.title || it.name || 'Без названия',
            summary: it.summary || it.description || it.excerpt || '',
            link: it.url || it.link || '#',
            source: it.source || it.feed || 'JSON',
            date: it.date || it.published_at || it.pubDate || it.time || ''
          }));
        }
        news = items.length ? items : BASE_NEWS;
        // reset pagination
        displayedCount = Math.min(PAGE_SIZE, getFilteredNews().length);
        localStorage.setItem(LS_LAST, JSON.stringify(news));
        setStatus('Готово');
      } catch (err) {
        console.error('loadNews', { err, url });
        const cached = JSON.parse(localStorage.getItem(LS_LAST) || 'null');
        news = cached && cached.length ? cached : BASE_NEWS;
        displayedCount = Math.min(PAGE_SIZE, getFilteredNews().length);
        const msg = err && err.message ? err.message : 'Ошибка загрузки';
        setStatus(msg + '. Ошибка загрузки, показан кэш', true);
      } finally {
        isLoading = false; renderNews();
      }
    }

    // Render
    function normalizeText(s) { return (s || '').toLowerCase(); }
    function getFilteredNews() {
      const q = normalizeText(document.getElementById('inputSearch')?.value || '');
      let list = news;
      if (favFilterOn) list = list.filter(it => favs.has(it.id));
      if (q) list = list.filter(it => {
        const title = normalizeText(it.title);
        const desc = normalizeText(it.summary);
        return title.includes(q) || desc.includes(q);
      });
      return list;
    }
    function formatTime(d) {
      if (!d) return '';
      const dt = new Date(d);
      if (Number.isNaN(dt.getTime())) {
        const parsed = Date.parse(d);
        if (Number.isNaN(parsed)) return '';
        return formatTime(new Date(parsed));
      }
      const now = new Date();
      const diff = Math.floor((now - dt) / 60000);
      if (diff < 60) return diff <= 1 ? 'только что' : `${diff} мин назад`;
      const hours = Math.floor(diff / 60);
      if (hours < 24) return `${hours} ч назад`;
      return dt.toLocaleDateString('ru-RU', { day: '2-digit', month: 'short' });
    }
    function updateStats(list) {
      const total = news.length || 0;
      const shown = list.length || 0;
      const srcId = localStorage.getItem(LS_SRC);
      const src = SOURCES.find(s => s.id === srcId);
      const countEl = document.getElementById('statCount');
      const srcEl = document.getElementById('statSource');
      if (countEl) countEl.textContent = `${shown} из ${total} новостей`;
      if (srcEl) srcEl.textContent = `Источник: ${src ? src.name : 'ручной'}`;
    }
    function renderNews() {
      const root = $('#news'); root.innerHTML = '';
      if (isLoading) {
        for (let i = 0; i < 4; i++) {
          const s = document.createElement('div'); s.className = 'card'; s.innerHTML = '<div class="skeleton" style="width:60%"></div><div style="height:8px"></div><div class="skeleton" style="width:90%"></div>'; root.appendChild(s);
        }
        return;
      }
      // render only up to displayedCount for 'Load more' pagination
      const filtered = getFilteredNews();
      const list = filtered.slice(0, displayedCount);
      updateStats(filtered);
      const empty = document.getElementById('emptyState');
      if (empty) empty.style.display = list.length ? 'none' : 'block';
      const frag = document.createDocumentFragment();
      list.forEach(it => {
        const tpl = document.getElementById('cardTpl');
        const node = tpl.content.firstElementChild.cloneNode(true);
        node.querySelector('.ttl').textContent = it.title;
        node.querySelector('.desc').textContent = it.summary ? (it.summary.replace(/<[^>]+>/g, '')) : '';
        node.querySelector('.source').textContent = it.source || '';
        node.querySelector('.time').textContent = formatTime(it.date);
        const favBtn = node.querySelector('.btnFav');
        favBtn.textContent = favs.has(it.id) ? '★' : '☆';
        favBtn.addEventListener('click', (ev) => { ev.stopPropagation(); toggleFav(it.id); favBtn.textContent = favs.has(it.id) ? '★' : '☆'; renderNews(); });
        node.addEventListener('click', (ev) => { if (ev.ctrlKey || ev.metaKey) { window.open(it.link, '_blank'); } else openDetail(it); });
        frag.appendChild(node);
      });
      root.appendChild(frag);
      // toggle Load more button
      const moreBtn = document.getElementById('btnLoadMore');
      if (moreBtn) moreBtn.disabled = displayedCount >= getFilteredNews().length;
    }

    // Modal
    function openDetail(it) {
      const root = $('#modalRoot'); root.style.display = 'flex'; root.innerHTML = '';
      const back = document.createElement('div'); back.className = 'modal-backdrop';
      const modal = document.createElement('div'); modal.className = 'modal';
      const timeLabel = formatTime(it.date);
      modal.innerHTML = `<button class="close">✖</button><div class="modal-body"><h3>${escapeHtml(it.title)}</h3><div style="color:var(--muted);font-size:12px;margin-top:6px">${escapeHtml(it.source || '')}${timeLabel ? ' · ' + timeLabel : ''}</div><div style="color:var(--muted);font-size:13px;margin-top:8px" id="modalSummary">${escapeHtml(it.summary || '')}</div><div id="translatedBlock" class="translate-output" style="display:none"></div></div><div class="modal-actions"><div id="translateSlot"></div><a id="openLink" class="btn" target="_blank">Открыть</a></div>`;
      back.appendChild(modal); root.appendChild(back);
      back.addEventListener('click', (e) => { if (e.target === back) closeDetail(); });
      modal.querySelector('.close').addEventListener('click', closeDetail);
      const openLink = modal.querySelector('#openLink'); openLink.href = it.link; openLink.textContent = 'Открыть источник';
      const translateSlot = modal.querySelector('#translateSlot');
      const translatedBlock = modal.querySelector('#translatedBlock');
      if (translateSlot && translatedBlock) {
        const translateRow = document.createElement('div');
        translateRow.className = 'translate-row';
        const translateBtn = document.createElement('button');
        translateBtn.id = 'btnTranslate';
        translateBtn.className = 'btn';
        translateBtn.textContent = '\uD83C\uDF10 Перевести';
        const openBtn = document.createElement('button');
        openBtn.id = 'btnTranslateOpen';
        openBtn.className = 'btn ghost';
        openBtn.textContent = '↗ Перевести (открыть)';
        const langSel = document.createElement('select');
        langSel.id = 'translateLang';
        langSel.className = 'lang-select';
        langSel.setAttribute('aria-label', 'Язык перевода');
        const optRu = document.createElement('option'); optRu.value = 'ru'; optRu.textContent = 'RU';
        const optEn = document.createElement('option'); optEn.value = 'en'; optEn.textContent = 'EN';
        langSel.appendChild(optRu); langSel.appendChild(optEn);
        translateRow.appendChild(translateBtn);
        translateRow.appendChild(openBtn);
        translateRow.appendChild(langSel);
        translateSlot.appendChild(translateRow);
        openBtn.addEventListener('click', () => {
          const target = langSel.value || 'ru';
          const rawText = (it.summary && it.summary.trim()) ? it.summary.trim() : (it.title || '').trim();
          if (!rawText) return;
          const text = rawText.slice(0, 1800);
          const url = `https://translate.google.com/?sl=auto&tl=${encodeURIComponent(target)}&text=${encodeURIComponent(text)}&op=translate`;
          window.open(url, '_blank');
        });
        translateBtn.addEventListener('click', async () => {
          const target = langSel.value || 'ru';
          const text = (it.summary && it.summary.trim()) ? it.summary.trim() : (it.title || '').trim();
          if (!text) return;
          const key = `${it.id}|${target}`;
          const cached = translations[key];
          if (cached) {
            translatedBlock.style.display = 'block';
            translatedBlock.innerHTML = escapeHtml(cached);
            translateBtn.textContent = 'Готово';
            translateBtn.disabled = true;
            setTimeout(() => { translateBtn.textContent = '\uD83C\uDF10 Перевести'; translateBtn.disabled = false; }, 1200);
            return;
          }
          translateBtn.textContent = 'Перевод...';
          translateBtn.disabled = true;
          try {
            const translated = await translateText(text, target);
            translations[key] = translated;
            localStorage.setItem(LS_TRANSLATIONS, JSON.stringify(translations));
            translatedBlock.style.display = 'block';
            translatedBlock.innerHTML = escapeHtml(translated || '');
            translateBtn.textContent = 'Готово';
            setTimeout(() => { translateBtn.textContent = '\uD83C\uDF10 Перевести'; translateBtn.disabled = false; }, 1200);
          } catch (err) {
            console.error('translate failed', err);
            translatedBlock.style.display = 'block';
            translatedBlock.innerHTML = escapeHtml('Перевод временно недоступен');
            translateBtn.textContent = 'Ошибка перевода';
            setTimeout(() => { translateBtn.textContent = '\uD83C\uDF10 Перевести'; translateBtn.disabled = false; }, 1500);
          }
        });
      }
    }

    function closeDetail() { const root = $('#modalRoot'); root.style.display = 'none'; root.innerHTML = ''; }

    // Translation cache
    let translations = {};
    try { translations = JSON.parse(localStorage.getItem(LS_TRANSLATIONS) || '{}') || {}; } catch (e) { translations = {}; }

    // Fav
    function toggleFav(id) { if (favs.has(id)) { favs.delete(id); } else { favs.add(id); } saveFavs(); }

    async function translateText(text, target = 'ru') {
      const res = await fetch(TRANSLATE_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ q: text, target })
      });
      if (!res.ok) {
        const msg = await res.text().catch(() => '');
        throw new Error(`translate http ${res.status} ${msg}`);
      }
      const data = await res.json();
      return data.translatedText || '';
    }

    // Simple escaping
    function escapeHtml(s) { if (!s) return ''; return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

    // Canvas background (light-weight)
    const canvas = document.getElementById('bgCanvas'); const ctx = canvas.getContext('2d'); let stars = [];
    function resizeCanvas() { canvas.width = innerWidth; canvas.height = innerHeight; }
    function createStars() { stars = []; const count = Math.round((innerWidth * innerHeight) / 70000); for (let i = 0; i < count; i++) { stars.push({ x: Math.random() * innerWidth, y: Math.random() * innerHeight, r: Math.random() * 1.2 + 0.2, a: Math.random() * 0.8 + 0.2, v: Math.random() * 0.2 - 0.05 }); } }
    function drawBg() { ctx.clearRect(0, 0, canvas.width, canvas.height); for (const s of stars) { s.x += s.v; if (s.x < 0) s.x = canvas.width; if (s.x > canvas.width) s.x = 0; ctx.globalAlpha = s.a; ctx.fillStyle = '#7fb2ff'; ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2); ctx.fill(); } ctx.globalAlpha = 1; requestAnimationFrame(drawBg); }
    function updateAppHeight() { document.documentElement.style.setProperty('--app-h', window.innerHeight + 'px'); }

    // Theme & UI init
    function applyTheme() { const saved = localStorage.getItem(LS_THEME); if (saved === 'dark') { document.documentElement.style.setProperty('--bg', '#071022'); } else if (saved === 'light') { document.documentElement.style.setProperty('--bg', '#f6f7fb'); document.documentElement.style.setProperty('--text', '#071022'); } }

    // Bind UI
    document.getElementById('btnLoad').addEventListener('click', () => { const v = document.getElementById('inputFeed').value.trim(); if (v) { fetchUrl = v; loadNews(fetchUrl); } else loadNews(); });
    const themeBtn = document.getElementById('btnToggleTheme'); if (themeBtn) themeBtn.addEventListener('click', () => { const cur = localStorage.getItem(LS_THEME); const next = cur === 'dark' ? 'light' : 'dark'; localStorage.setItem(LS_THEME, next); applyTheme(); });
    const bgToggleBtn = document.getElementById('bgToggle'); if (bgToggleBtn) bgToggleBtn.addEventListener('click', () => { const cur = localStorage.getItem(LS_BG) === '1'; localStorage.setItem(LS_BG, cur ? '0' : '1'); updateBgToggle(); });
    const searchInput = document.getElementById('inputSearch');
    if (searchInput) searchInput.addEventListener('input', () => { displayedCount = PAGE_SIZE; renderNews(); });
    const clearSearch = document.getElementById('btnClearSearch');
    if (clearSearch) clearSearch.addEventListener('click', () => { if (searchInput) searchInput.value = ''; displayedCount = PAGE_SIZE; renderNews(); });
    const favFilterBtn = document.getElementById('btnFavFilter');
    if (favFilterBtn) favFilterBtn.addEventListener('click', () => {
      favFilterOn = !favFilterOn;
      favFilterBtn.classList.toggle('active', favFilterOn);
      favFilterBtn.setAttribute('aria-pressed', favFilterOn ? 'true' : 'false');
      displayedCount = PAGE_SIZE;
      renderNews();
    });
    // Load more button
    const loadMoreBtn = document.getElementById('btnLoadMore'); if (loadMoreBtn) { loadMoreBtn.addEventListener('click', () => { const list = getFilteredNews(); if (!list || !list.length) return; displayedCount = Math.min(list.length, displayedCount + PAGE_SIZE); renderNews(); }); }

    function updateBgToggle() { const on = localStorage.getItem(LS_BG) !== '0'; const el = document.getElementById('bgToggle'); if (el) el.classList.toggle('on', on); if (on) { resizeCanvas(); createStars(); drawBg(); } }
    function updateAdvancedVisibility() {
      const adv = document.getElementById('feedAdvanced');
      if (!adv) return;
      const isMobile = window.matchMedia('(max-width: 520px)').matches;
      if (!isMobile) { adv.classList.add('show'); return; }
      const saved = localStorage.getItem(LS_UI_ADVANCED) === '1';
      adv.classList.toggle('show', saved);
    }
    function setAdvanced(open) {
      localStorage.setItem(LS_UI_ADVANCED, open ? '1' : '0');
      updateAdvancedVisibility();
    }
    const advBtn = document.getElementById('btnToggleAdvanced');
    if (advBtn) advBtn.addEventListener('click', () => {
      const adv = document.getElementById('feedAdvanced');
      const isOpen = adv && adv.classList.contains('show');
      setAdvanced(!isOpen);
    });

    // Boot
    window.addEventListener('resize', () => { resizeCanvas(); updateAppHeight(); updateAdvancedVisibility(); });
    window.addEventListener('load', () => {
      updateAppHeight();
      applyTheme();
      // populate source selector and restore selection
      try { loadSources(); } catch (e) { console.warn('loadSources failed', e); }
      // restore cached data
      try { const cached = JSON.parse(localStorage.getItem(LS_LAST) || 'null'); if (cached && cached.length) { news = cached; } } catch (e) { }
      try { favs = new Set(JSON.parse(localStorage.getItem(LS_FAV) || '[]')); } catch (e) { favs = new Set(); }
      updateAdvancedVisibility();
      // if a saved source exists, load it; otherwise show default fetchUrl
      const savedSrc = localStorage.getItem(LS_SRC);
      if (savedSrc) { document.getElementById('inputFeed').value = (SOURCES.find(s => s.id === savedSrc) || {}).url || fetchUrl; renderNews(); updateBgToggle(); loadNewsById(savedSrc); }
      else { document.getElementById('inputFeed').value = fetchUrl; renderNews(); updateBgToggle(); loadNews(); }
    });

    // Global error handlers for debugging
    window.addEventListener('error', (e) => { console.error('Global error', e.error || e); });
    window.addEventListener('unhandledrejection', (e) => { console.error('Unhandled rejection', e.reason); });
  </script>
</body>

</html>
