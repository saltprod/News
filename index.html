<!doctype html>
<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>–ú–æ—è –ª–µ–Ω—Ç–∞ ‚Äî Telegram Mini App</title>
    <style>
        /* --- –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –º–æ–±–∏–ª—å–Ω—ã–π —Å—Ç–∏–ª—å --- */
        :root{
            --bg:#ffffff;
            --surface:#f6f7f9;
            --text:#111827;
            --muted:#6b7280;
            --accent:#2a8cff;
            --pill-bg:#e6f0ff;
        }
        html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--text);-webkit-text-size-adjust:100%;}
        .app{min-height:100vh;display:flex;flex-direction:column;}
        header{padding:12px 16px;background:var(--surface);border-bottom:1px solid rgba(0,0,0,0.06);display:flex;flex-direction:column;gap:6px;position:sticky;top:0;z-index:3;}
        header .title-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
        header h1{margin:0;font-size:17px;font-weight:600;}
        header .user{font-size:13px;color:var(--muted)}
        main{padding:12px 12px 96px;flex:1 1 auto;}
        .news-list{display:flex;flex-direction:column;gap:10px;}
        .card{background:linear-gradient(180deg, rgba(255,255,255,0.6), transparent), var(--bg);border-radius:10px;padding:12px;box-shadow:0 1px 0 rgba(0,0,0,0.04);border:1px solid rgba(0,0,0,0.04);cursor:pointer;}
        .card h3{margin:0 0 6px 0;font-size:15px;line-height:1.2;}
        .card p{margin:0;color:var(--muted);font-size:13px;line-height:1.4;max-height:3.2em;overflow:hidden;}
        .meta{margin-top:8px;font-size:12px;color:var(--muted);display:flex;justify-content:space-between;align-items:center;}
        .fav-btn{background:transparent;border:0;color:var(--accent);font-weight:600;font-size:12px;padding:6px 8px;border-radius:8px;cursor:pointer;}
        .bottom-bar{position:fixed;left:0;right:0;bottom:0;display:flex;gap:8px;padding:10px;background:var(--surface);border-top:1px solid rgba(0,0,0,0.06);justify-content:space-between;align-items:center;z-index:4;}
        .btn{background:var(--accent);color:white;border:0;padding:10px 12px;border-radius:10px;font-weight:600;font-size:14px;flex:1;margin:0 6px;max-width:160px;}
        .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--text);}
        .modal-backdrop{position:fixed;left:0;right:0;top:0;bottom:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:10;padding:18px;}
        .modal{width:100%;max-width:720px;background:var(--bg);border-radius:12px;padding:16px;box-shadow:0 12px 30px rgba(0,0,0,0.2);max-height:90vh;overflow:auto;}
        .modal h3{margin:0 0 8px 0;}
        .modal .close{float:right;background:transparent;border:0;font-size:18px;color:var(--muted);cursor:pointer;}
        .settings-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-top:1px solid rgba(0,0,0,0.04);}
        .toggle{width:44px;height:26px;background:var(--pill-bg);border-radius:20px;position:relative;cursor:pointer;flex:0 0 auto;}
        .toggle .dot{width:20px;height:20px;background:white;border-radius:50%;position:absolute;top:3px;left:3px;transition:all .18s;box-shadow:0 1px 2px rgba(0,0,0,0.08);}
        .toggle.on{background:var(--accent);}
        .toggle.on .dot{left:21px;}
        .empty{text-align:center;color:var(--muted);padding:40px 8px;}
        #debugBanner{display:none;padding:8px 12px;font-size:13px;color:var(--muted);background:rgba(255,0,0,0.03);margin-top:8px;border-radius:8px}
    /* canvas background sits behind the app */
    #bgCanvas{position:fixed;inset:0;width:100%;height:100%;z-index:0;pointer-events:none;display:block}
    /* translucent overlay to keep text readable over animated background */
    :root{--app-overlay: rgba(255,255,255,0.65);} /* default lighter overlay */
    .app{position:relative;z-index:2}
    .app::before{content:"";position:absolute;inset:0;background:var(--app-overlay);backdrop-filter: blur(3px);-webkit-backdrop-filter: blur(3px);z-index:1;pointer-events:none}
    .app > *{position:relative;z-index:2}
        @media (prefers-color-scheme: dark){
            :root{--bg:#0b1220;--surface:#071022;--text:#e6eef8;--muted:#9fb3d6;--accent:#2a8cff;--pill-bg:rgba(255,255,255,0.06);} 
            /* darker, more transparent overlay on dark theme so stars remain visible */
            :root{--app-overlay: rgba(6,8,14,0.24);} 
        }
    </style>
</head>
<body>
<!-- Animated background canvas (stars & planets) -->
<canvas id="bgCanvas" aria-hidden="true"></canvas>
<div class="app" id="app">
    <header>
        <div class="title-row">
            <h1>–ú–æ—è –ª–µ–Ω—Ç–∞</h1>
            <div style="display:flex;gap:8px;align-items:center">
                <button id="btnClose" class="btn ghost" title="–ó–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ" style="padding:8px 10px;max-width:120px">‚úñ –ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
        <div class="user" id="userInfo">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è‚Ä¶</div>

        <!-- DEBUG: –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∏ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –≤ WebApp -->
        <div id="debugBanner" aria-live="polite"></div>
    </header>

    <main>
        <div id="news" class="news-list" aria-live="polite"></div>
        <div id="empty" class="empty" style="display:none">–ù–æ–≤–æ—Å—Ç–µ–π –Ω–µ—Ç. –ù–∞–∂–º–∏—Ç–µ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª.</div>
    </main>

    <nav class="bottom-bar" role="navigation" aria-label="–ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å">
        <button id="btnRefresh" class="btn ghost">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <button id="btnFav" class="btn">‚òÜ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
        <button id="btnSettings" class="btn ghost">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </nav>
</div>

<!-- –º–æ–¥–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã -->
<div id="modalDetail" class="modal-backdrop" style="display:none" role="dialog" aria-modal="true">
    <div class="modal" role="document">
        <button class="close" id="detailClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        <h3 id="detailTitle"></h3>
        <div style="color:var(--muted);font-size:13px;margin-bottom:8px" id="detailDate"></div>
        <p id="detailContent" style="white-space:pre-wrap"></p>
        <div style="margin-top:12px;text-align:right">
            <button id="detailFav" class="fav-btn">–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
        </div>
    </div>
</div>

<div id="modalSettings" class="modal-backdrop" style="display:none" role="dialog" aria-modal="true">
    <div class="modal" role="document">
        <button class="close" id="settingsClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
        <div class="settings-row">
            <div>–¢—ë–º–Ω–∞—è —Ç–µ–º–∞ (override)</div>
            <div id="themeToggle" class="toggle" role="switch" aria-checked="false"><div class="dot"></div></div>
        </div>
        <div class="settings-row">
            <div>–ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω</div>
            <div id="bgToggle" class="toggle" role="switch" aria-checked="false"><div class="dot"></div></div>
        </div>
        <div style="margin-top:12px;color:var(--muted);font-size:13px">
            –¢–µ–º—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–µ—Ä—É—Ç—Å—è –∏–∑ Telegram (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã). –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—ã–±–æ—Ä –ª–æ–∫–∞–ª—å–Ω–æ.
        </div>
    </div>
</div>

<script>
/*
  Telegram Mini App ‚Äî –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π —Ñ–∞–π–ª.
  - mock data –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å fetchUrl –Ω–∞ –≤–Ω–µ—à–Ω–∏–π API
  - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å window.Telegram.WebApp
  - favorites –≤ localStorage
  - —Ç–µ–º–∞ –∏–∑ themeParams —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é override
*/

/* ========== –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ========== */
// –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å –Ω–æ–≤–æ—Å—Ç–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞, –ø–æ—Å—Ç–∞–≤—å—Ç–µ fetchUrl = '/fetch' (–∏–ª–∏ –ª—é–±–æ–π HTTPS-endpoint)
const fetchUrl = null; // '/fetch' –∏–ª–∏ null -> –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å mock BASE_NEWS

/* ========== Mock data (–ª–µ–≥–∫–æ –∑–∞–º–µ–Ω–∏—Ç—å) ========== */
const BASE_NEWS = [
    { id:'1', title:'–ù–æ–≤—ã–π –≥–æ—Ä–æ–¥—Å–∫–æ–π –ø–∞—Ä–∫ –æ—Ç–∫—Ä—ã–ª—Å—è –≤ —Ü–µ–Ω—Ç—Ä–µ', excerpt:'–ü–∞—Ä–∫ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∑–æ–Ω—ã –¥–ª—è –ø—Ä–æ–≥—É–ª–æ–∫, –¥–µ—Ç—Å–∫—É—é –ø–ª–æ—â–∞–¥–∫—É –∏ –≤–µ–ª–æ–¥–æ—Ä–æ–∂–∫–∏.', content:'–°–µ–≥–æ–¥–Ω—è –≤ —Ü–µ–Ω—Ç—Ä–µ –≥–æ—Ä–æ–¥–∞ –æ—Ç–∫—Ä—ã–ª—Å—è –Ω–æ–≤—ã–π –≥–æ—Ä–æ–¥—Å–∫–æ–π –ø–∞—Ä–∫. –û–Ω –≤–∫–ª—é—á–∞–µ—Ç –ø—Ä–æ–≥—É–ª–æ—á–Ω—ã–µ –∞–ª–ª–µ–∏, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–µ—Ç—Å–∫—É—é –ø–ª–æ—â–∞–¥–∫—É, –∑–æ–Ω—ã –¥–ª—è –ø–∏–∫–Ω–∏–∫–∞ –∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥–Ω—ã–µ –¥–æ—Ä–æ–∂–∫–∏. –û–∂–∏–¥–∞–µ—Ç—Å—è, —á—Ç–æ –ø–∞—Ä–∫ —Å—Ç–∞–Ω–µ—Ç –ø–æ–ø—É–ª—è—Ä–Ω—ã–º –º–µ—Å—Ç–æ–º –¥–ª—è —Å–µ–º–µ–π–Ω—ã—Ö –ø—Ä–æ–≥—É–ª–æ–∫ –∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π.', date:'2026-01-11' },
    { id:'2', title:'–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–∞—Ä—Ç–∞–ø –ø—Ä–∏–≤–ª—ë–∫ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π', excerpt:'–ö–æ–º–ø–∞–Ω–∏—è –∑–∞–∫—Ä—ã–ª–∞ —Ä–∞—É–Ω–¥ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π –Ω–∞ —Å—Ç–∞–¥–∏–∏ seed –∏ –≥–æ—Ç–æ–≤–∏—Ç –ø—Ä–æ–¥—É–∫—Ç –∫ –∑–∞–ø—É—Å–∫—É.', content:'–°—Ç–∞—Ä—Ç–∞–ø, —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—é—â–∏–π —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ä—É—Ç–∏–Ω–Ω—ã—Ö –∑–∞–¥–∞—á, –ø—Ä–∏–≤–ª—ë–∫ $1.2M –≤ —Ä–∞—É–Ω–¥–µ seed. –°—Ä–µ–¥—Å—Ç–≤–∞ –ø–æ–π–¥—É—Ç –Ω–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã –∏ –∑–∞–ø—É—Å–∫ –±–µ—Ç–∞-–≤–µ—Ä—Å–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞ –¥–ª—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤.', date:'2026-01-10' },
    { id:'3', title:'–ú–µ—Å—Ç–Ω—ã–µ –≤—ã–±–æ—Ä—ã –ø—Ä–æ—à–ª–∏ –≤ —à—Ç–∞—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ', excerpt:'–Ø–≤–∫–∞ –∏–∑–±–∏—Ä–∞—Ç–µ–ª–µ–π –ø—Ä–µ–≤—ã—Å–∏–ª–∞ –æ–∂–∏–¥–∞–Ω–∏—è, –Ω–∞–±–ª—é–¥–∞—é—Ç—Å—è –Ω–µ–±–æ–ª—å—à–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è.', content:'–í—ã–±–æ—Ä—ã –ø—Ä–æ—à–ª–∏ —Å –≤—ã—Å–æ–∫–æ–π —è–≤–∫–æ–π. –ù–∞–±–ª—é–¥–∞—Ç–µ–ª–∏ –æ—Ç–º–µ—á–∞—é—Ç –µ–¥–∏–Ω–∏—á–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–¥—É—Ä, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø–æ–≤–ª–∏—è–ª–∏ –Ω–∞ –∏—Ç–æ–≥.', date:'2026-01-09' },
    { id:'4', title:'–°–æ–≤–µ—Ç—ã –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏: 5 –ø—Ä–æ—Å—Ç—ã—Ö —à–∞–≥–æ–≤', excerpt:'–ù–µ–±–æ–ª—å—à–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –≤–Ω–µ–¥—Ä–∏—Ç—å —É–∂–µ —Å–µ–≥–æ–¥–Ω—è.', content:'1) –ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ —É—Ç—Ä–æ; 2) –†–∞–∑–±–∏–≤–∞–π—Ç–µ –∑–∞–¥–∞—á–∏ –Ω–∞ –±–ª–æ–∫–∏; 3) –û—Ç–∫–ª—é—á–∞–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è; 4) –î–µ–ª—è–π—Ç–µ –±–æ–ª—å—à–æ–π –ø—Ä–æ–µ–∫—Ç –Ω–∞ —ç—Ç–∞–ø—ã; 5) –†–µ–≥—É–ª—è—Ä–Ω–æ –¥–µ–ª–∞–π—Ç–µ –ø–∞—É–∑—ã.', date:'2026-01-08' }
];

/* ========== State –∏ –∫–ª—é—á–∏ localStorage ========== */
let news = [...BASE_NEWS];
let showOnlyFav = false;
const LS_FAV = 'tg_minapp_fav_v1';
const LS_THEME = 'tg_minapp_theme_override';

/* ========== –£—Ç–∏–ª–∏—Ç—ã ========== */
const $ = id => document.getElementById(id);
const loadFav = () => JSON.parse(localStorage.getItem(LS_FAV) || '[]');
const saveFav = arr => localStorage.setItem(LS_FAV, JSON.stringify(arr));
const isFav = id => loadFav().includes(id);
const toggleFav = id => { const fav = loadFav(); const i = fav.indexOf(id); if(i>=0) fav.splice(i,1); else fav.push(id); saveFav(fav); };

function escapeHtml(s){ return String(s).replace(/[&<>\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function formatDate(d){ try{ const dt = new Date(d); return dt.toLocaleDateString(); }catch(e){ return d; } }
function setToggle(id, on){ const el = $(id); if(!el) return; el.classList.toggle('on', on); el.setAttribute('aria-checked', on ? 'true' : 'false'); }

/* ========== –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ª–µ–Ω—Ç—ã ========== */
function renderNews(){
    const container = $('news');
    container.innerHTML = '';
    let list = news.slice();
    if(showOnlyFav) list = list.filter(n => isFav(n.id));
    if(list.length === 0){ $('empty').style.display = 'block'; return; } else $('empty').style.display='none';
    list.forEach(item => {
        const card = document.createElement('article');
        card.className = 'card';
        card.setAttribute('tabindex','0');
        card.innerHTML = `<h3>${escapeHtml(item.title)}</h3>` +
                          `<p>${escapeHtml(item.excerpt)}</p>` +
                          `<div class=\"meta\"><span>${escapeHtml(formatDate(item.date))}</span><button class=\"fav-btn\" data-id=\"${item.id}\">${isFav(item.id)?'‚òÖ –£–±—Ä–∞–Ω–Ω–æ–µ':'‚òÜ –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'}</button></div>`;
        card.addEventListener('click', ()=> openDetail(item.id));
        card.addEventListener('keydown', (e)=>{ if(e.key==='Enter') openDetail(item.id); });
        card.querySelector('.fav-btn').addEventListener('click', (ev)=>{
            ev.stopPropagation();
            toggleFav(ev.currentTarget.getAttribute('data-id'));
            renderNews();
        });
        container.appendChild(card);
    });
}

/* ========== –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π ========== */
function openDetail(id){
    const item = news.find(n => n.id === id);
    if(!item) return;
    $('detailTitle').textContent = item.title;
    $('detailDate').textContent = formatDate(item.date);
    $('detailContent').textContent = item.content;
    $('detailFav').textContent = isFav(id) ? '–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ';
    $('detailFav').onclick = () => { toggleFav(id); $('detailFav').textContent = isFav(id) ? '–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'; renderNews(); };
    $('modalDetail').style.display = 'flex';
}
function closeDetail(){ $('modalDetail').style.display = 'none'; }

/* ========== Settings modal –∏ —Ç–µ–º–∞ ========== */
function applyTelegramTheme(themeParams){
    // override –∏–∑ localStorage: 'dark' | 'light' | null
    const override = localStorage.getItem(LS_THEME);
    const tgIsDark = themeParams?.theme === 'dark' || themeParams?.is_dark;
    const isDark = override ? (override === 'dark') : tgIsDark;
    const tp = themeParams || {};
    const bg = tp.bg_color || tp.background_color || (isDark ? '#0b1220' : '#ffffff');
    const surface = tp.secondary_bg_color || (isDark ? '#071022' : '#f6f7f9');
    const text = tp.text_color || (isDark ? '#e6eef8' : '#111827');
    const muted = tp.hint_color || (isDark ? '#9fb3d6' : '#6b7280');
    const accent = tp.button_color || tp.accent_color || '#2a8cff';
    const pill = tp.section_bg_color || (isDark ? 'rgba(255,255,255,0.06)' : '#e6f0ff');

    const set = (k,v) => document.documentElement.style.setProperty(k, v);
    set('--bg', bg); set('--surface', surface); set('--text', text); set('--muted', muted); set('--accent', accent); set('--pill-bg', pill);
    setToggle('themeToggle', isDark);
}

/* ========== Debug helpers ========== */
function showDebug(msg, isError = false, details){
    const el = $('debugBanner');
    if(!el) return;
    el.style.display = 'block';
    el.style.color = isError ? '#c92a2a' : 'var(--muted)';
    // set main text
    try{ el.textContent = (typeof msg === 'string') ? msg : JSON.stringify(msg); }catch(e){ el.textContent = String(msg); }

    // attach optional details (stack or object)
    const prev = el.querySelector('pre'); if(prev) prev.remove();
    if(details){
        const pre = document.createElement('pre');
        pre.style.whiteSpace = 'pre-wrap'; pre.style.marginTop = '6px'; pre.style.color = 'inherit';
        pre.textContent = (typeof details === 'string') ? details : JSON.stringify(details, null, 2);
        el.appendChild(pre);
    }

    // console log for easier remote debugging
    try{ console[isError ? 'error' : 'log']('[MiniApp Debug]', msg, details || ''); }catch(e){}
}
function hideDebug(){ const el = $('debugBanner'); if(el) el.style.display='none'; }

// Global error handlers to capture unexpected failures inside Telegram WebView
window.addEventListener('error', function(e){
    const msg = e && (e.message || e.type) ? (e.message || e.type) : 'Script error';
    const stack = e && e.error && e.error.stack ? e.error.stack : (e.filename ? `${e.filename}:${e.lineno}:${e.colno}` : 'no-stack');
    showDebug(msg, true, stack);
    console.error('[MiniApp window.onerror]', e);
});

window.addEventListener('unhandledrejection', function(ev){
    const reason = ev && ev.reason ? ev.reason : 'unknown';
    const details = reason && reason.stack ? reason.stack : (typeof reason === 'object' ? JSON.stringify(reason) : String(reason));
    showDebug('Unhandled promise rejection', true, details);
    console.error('[MiniApp unhandledrejection]', ev);
});

/* ========== –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π (mock –∏–ª–∏ fetch) ========== */
async function loadNews(){
    if(fetchUrl){
        try{
            const res = await fetch(fetchUrl, { cache: "no-store" });
            if(!res.ok) throw new Error('fetch failed: ' + res.status);
            const data = await res.json();
            news = Array.isArray(data) ? data : news;
        }catch(e){
            console.warn('Fetch news failed, falling back to mock', e);
            showDebug('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π: ' + (e.message||e), true);
            news = [...BASE_NEWS];
        }
    } else {
        news = [...BASE_NEWS];
    }
    renderNews();
}

/* ========== –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ (—Å–∏–º—É–ª—è—Ü–∏—è + —Ä–µ–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞) ========== */
async function refresh(){
    if(fetchUrl){
        await loadNews();
    } else {
        const now = new Date();
        const id = String(Date.now());
        const title = `–°–≤–µ–∂–∞—è –Ω–æ–≤–æ—Å—Ç—å ${now.toLocaleTimeString()}`;
        news.unshift({ id, title, excerpt: '–≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–µ—Å—Ç–æ–≤–∞—è –Ω–æ–≤–æ—Å—Ç—å.', content: title + '\n\n–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ mock.', date: now.toISOString().slice(0,10) });
        renderNews();
    }
}

/* ========== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram ========== */
function init(){
    // –∫–Ω–æ–ø–∫–∏
    $('btnRefresh').addEventListener('click', ()=> refresh());
    $('btnFav').addEventListener('click', ()=>{
        showOnlyFav = !showOnlyFav;
        $('btnFav').textContent = showOnlyFav ? 'üîñ –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ' : '‚òÜ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ';
        renderNews();
    });
    $('btnSettings').addEventListener('click', ()=> $('modalSettings').style.display = 'flex');
    $('btnClose').addEventListener('click', ()=> {
        const WebApp = window.Telegram?.WebApp;
        if(WebApp && typeof WebApp.close === 'function') WebApp.close();
        else window.close();
    });

    // –º–æ–¥–∞–ª–∫–∏: –∑–∞–∫—Ä—ã—Ç—å –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω –∏–ª–∏ –∫—Ä–µ—Å—Ç–∏–∫—É
    $('detailClose').addEventListener('click', closeDetail);
    $('modalDetail').addEventListener('click', (e)=> { if(e.target === $('modalDetail')) closeDetail(); });
    $('settingsClose').addEventListener('click', ()=> $('modalSettings').style.display = 'none');
    $('modalSettings').addEventListener('click', (e)=> { if(e.target === $('modalSettings')) $('modalSettings').style.display = 'none'; });

    // –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã (override)
    $('themeToggle').addEventListener('click', ()=>{
        const on = $('themeToggle').classList.toggle('on');
        setToggle('themeToggle', on);
        localStorage.setItem(LS_THEME, on ? 'dark' : 'light');
        applyTelegramTheme(window.Telegram?.WebApp?.themeParams || {});
    });

    // Esc –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫–∏
    document.addEventListener('keydown', (e)=> { if(e.key === 'Escape'){ closeDetail(); $('modalSettings').style.display = 'none'; } });

    // TELEGRAM INIT + –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
    try {
        const WebApp = window.Telegram?.WebApp;
        if(!WebApp){
            showDebug('Telegram.WebApp –ù–ï –æ–±–Ω–∞—Ä—É–∂–µ–Ω ‚Äî –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É web_app –≤ –±–æ—Ç–µ (—Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏).');
            applyTelegramTheme(window.Telegram?.WebApp?.themeParams || {});
            $('userInfo').textContent = '–†–∞–±–æ—Ç–∞ –≤–Ω–µ Telegram (—Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏)';
        } else {
            try{ WebApp.ready(); }catch(e){ console.warn('WebApp.ready() error', e); }
            const user = WebApp.initDataUnsafe?.user;
            if(user){
                const name = [user.first_name, user.last_name].filter(Boolean).join(' ');
                const username = user.username ? ('@' + user.username) : '';
                $('userInfo').textContent = name + (username ? ' ¬∑ ' + username : '');
            } else {
                $('userInfo').textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω';
            }

            try{
                applyTelegramTheme(WebApp.themeParams || {});
                if(typeof WebApp.onEvent === 'function') WebApp.onEvent('themeChanged', ()=> applyTelegramTheme(WebApp.themeParams || {}));
                else if(typeof WebApp.onThemeChange === 'function') WebApp.onThemeChange(()=> applyTelegramTheme(WebApp.themeParams || {}));
            }catch(e){
                console.warn('theme apply error', e);
            }

            try{ if(typeof WebApp.expand === 'function') WebApp.expand(); }catch(e){ /* ignore */ }

            try{
                const initData = WebApp.initData;
                if(!initData) showDebug('Telegram initData –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ WebApp –æ—Ç–∫—Ä—ã—Ç –Ω–∞–ø—Ä—è–º—É—é, –∞ –Ω–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –±–æ—Ç–∞.', true);
                else hideDebug();
            }catch(e){
                console.warn('initData check failed', e);
            }
        }
    } catch(e){
        console.warn('Telegram init error', e);
        showDebug('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram.WebApp: ' + (e.message||e), true);
    }

    // –Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ª–µ–Ω—Ç—ã
    loadNews();
}

/* ========== Boot ========== */
init();

</script>
<script>
/* Animated background: stars and planets on a <canvas> */
(function(){
    const canvas = document.getElementById('bgCanvas');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    let w = 0, h = 0, dpr = Math.max(1, window.devicePixelRatio || 1);
    let stars = [];
    let planets = [];
    let running = true;

    function resize(){
        w = window.innerWidth; h = window.innerHeight;
        canvas.width = Math.floor(w * dpr);
        canvas.height = Math.floor(h * dpr);
        canvas.style.width = w + 'px';
        canvas.style.height = h + 'px';
        ctx.setTransform(dpr,0,0,dpr,0,0);
    }

    function rand(min,max){ return Math.random()*(max-min)+min; }

    function createStars(){
        stars = [];
        // density based on area, capped for performance
        const area = (w*h)/100000; // heuristic
        const count = Math.min(220, Math.max(40, Math.floor(80 * area)));
        for(let i=0;i<count;i++){
            stars.push({
                x: Math.random()*w,
                y: Math.random()*h,
                r: Math.random()*1.2 + 0.3,
                speed: Math.random()*0.2 + 0.02,
                alpha: Math.random()*0.7 + 0.3,
                twinkle: Math.random()*0.02 + 0.005
            });
        }
    }

    // convert HSL to RGB (h in [0,360], s,l in [0,1])
    function hslToRgb(h, s, l){
        h = h % 360; if(h<0) h += 360;
        const c = (1 - Math.abs(2*l - 1)) * s;
        const hp = h / 60;
        const x = c * (1 - Math.abs(hp % 2 - 1));
        let r1=0,g1=0,b1=0;
        if(hp >= 0 && hp < 1){ r1 = c; g1 = x; b1 = 0; }
        else if(hp < 2){ r1 = x; g1 = c; b1 = 0; }
        else if(hp < 3){ r1 = 0; g1 = c; b1 = x; }
        else if(hp < 4){ r1 = 0; g1 = x; b1 = c; }
        else if(hp < 5){ r1 = x; g1 = 0; b1 = c; }
        else { r1 = c; g1 = 0; b1 = x; }
        const m = l - c/2;
        return { r: Math.round((r1 + m)*255), g: Math.round((g1 + m)*255), b: Math.round((b1 + m)*255) };
    }

    function createPlanets(){
        planets = [];
        const maxPlanets = Math.min(3, Math.floor(w/400));
        for(let i=0;i<maxPlanets;i++){
            const size = rand(28, 80) * (Math.min(1.6, w/400));
            const h = Math.floor(rand(0,360));
            const s = rand(40,70)/100;
            const l = rand(30,60)/100;
            const rgb = hslToRgb(h,s,l);
            planets.push({
                x: rand(-size, w+size),
                y: rand(h*0.05, h*0.6),
                r: size,
                vx: rand(0.02, 0.3) * (i%2?1:-1),
                color: `rgb(${rgb.r},${rgb.g},${rgb.b})`,
                rgb: rgb,
                ring: Math.random()>0.6
            });
        }
    }

    function draw(){
        if(!running) return;
        ctx.clearRect(0,0,w,h);

        // subtle gradient background
        const g = ctx.createLinearGradient(0,0,0,h);
        g.addColorStop(0, 'rgba(6,10,25,1)');
        g.addColorStop(1, 'rgba(2,6,20,1)');
        ctx.fillStyle = g;
        ctx.fillRect(0,0,w,h);

        // stars
        for(const s of stars){
            s.x -= s.speed * (dpr*0.6);
            s.y += Math.sin((s.x+s.y)*0.0003) * 0.1;
            s.alpha += (Math.random()-0.5)*s.twinkle;
            s.alpha = Math.max(0.15, Math.min(1, s.alpha));
            if(s.x < -10) s.x = w + 10;
            ctx.beginPath();
            ctx.fillStyle = `rgba(255,255,255,${s.alpha})`;
            ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
            ctx.fill();
        }

        // planets
        for(const p of planets){
            p.x += p.vx * (dpr*0.7);
            if(p.x - p.r > w + 40) p.x = -p.r - 40;
            if(p.x + p.r < -40) p.x = w + p.r + 40;

            // glow
            const grad = ctx.createRadialGradient(p.x, p.y, p.r*0.1, p.x, p.y, p.r*1.6);
            const c = p.rgb || {r:255,g:200,b:160};
            grad.addColorStop(0, `rgba(${c.r},${c.g},${c.b},0.95)`);
            grad.addColorStop(0.6, `rgba(${c.r},${c.g},${c.b},0.25)`);
            grad.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = grad;
            ctx.beginPath(); ctx.arc(p.x, p.y, p.r*1.6, 0, Math.PI*2); ctx.fill();

            // planet core
            ctx.beginPath(); ctx.fillStyle = p.color; ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();

            // ring
            if(p.ring){
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(Math.sin(p.x*0.001 + p.y*0.001) * 0.4);
                ctx.beginPath();
                ctx.ellipse(0, 0, p.r*1.6, p.r*0.4, 0, 0, Math.PI*2);
                ctx.strokeStyle = 'rgba(255,255,255,0.08)';
                ctx.lineWidth = Math.max(1, Math.floor(p.r*0.08));
                ctx.stroke();
                ctx.restore();
            }
        }

        requestAnimationFrame(draw);
    }

    // settings toggle: respect localStorage flag
    const BG_KEY = 'tg_minapp_bg_anim_v1';
    function isBgEnabled(){
        const v = localStorage.getItem(BG_KEY);
        return v === null ? true : v === '1';
    }

    function startOrStop(){
        if(isBgEnabled()){ running = true; canvas.style.display = 'block'; } else { running = false; canvas.style.display = 'none'; }
    }

    // init
    function init(){
        resize();
        createStars();
        createPlanets();
        window.addEventListener('resize', ()=>{ resize(); createStars(); createPlanets(); });
        startOrStop();
        requestAnimationFrame(draw);
    }

    // expose a toggle method for Settings UI (if exists)
    window.__MiniAppBg = {
        toggle(){ const enabled = !isBgEnabled(); localStorage.setItem(BG_KEY, enabled ? '1' : '0'); startOrStop(); return enabled; },
        enabled: isBgEnabled
    };

    // small safety: initialize after a tick
    setTimeout(init, 50);
})();
</script>
<script>
// Hook the Settings toggle (bgToggle) to the background API
(function(){
    function safe(fn){ try{ fn(); }catch(e){ console.warn('bgToggle hook error', e); } }
    const el = document.getElementById('bgToggle');
    if(!el) return;
    // reflect initial state
    const setState = (on)=>{ el.classList.toggle('on', on); el.setAttribute('aria-checked', on ? 'true' : 'false'); };
    safe(()=> setState( window.__MiniAppBg && window.__MiniAppBg.enabled ? window.__MiniAppBg.enabled() : (localStorage.getItem('tg_minapp_bg_anim_v1') !== '0') ));
    el.addEventListener('click', ()=>{
        const enabled = safe(()=> window.__MiniAppBg.toggle());
        // if safe() returned undefined, fallback to reading localStorage
        const isEnabled = (enabled === undefined) ? (localStorage.getItem('tg_minapp_bg_anim_v1') !== '0') : enabled;
        setState(isEnabled);
    });
})();
</script>

</body>
</html>
            :root{--bg:#0b1220;--surface:#071022;--text:#e6eef8;--muted:#9fb3d6;--accent:#2a8cff;--pill-bg:rgba(255,255,255,0.06);}
        }
    </style>
</head>
<body>
<div class="app" id="app">
    <header>
        <div class="title-row">
            <h1>–ú–æ—è –ª–µ–Ω—Ç–∞</h1>
            <div style="display:flex;gap:8px;align-items:center">
                <button id="btnClose" class="btn ghost" title="–ó–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ" style="padding:8px 10px;max-width:120px">‚úñ –ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
        <div class="user" id="userInfo">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è‚Ä¶</div>
    </header>

    <main>
        <div id="news" class="news-list" aria-live="polite"></div>
        <div id="empty" class="empty" style="display:none">–ù–æ–≤–æ—Å—Ç–µ–π –Ω–µ—Ç. –ù–∞–∂–º–∏—Ç–µ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª.</div>
    </main>

    <nav class="bottom-bar" role="navigation" aria-label="–ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å">
        <button id="btnRefresh" class="btn ghost">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <button id="btnFav" class="btn">‚òÜ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
        <button id="btnSettings" class="btn ghost">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </nav>
</div>

<!-- –º–æ–¥–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã -->
<div id="modalDetail" class="modal-backdrop" style="display:none" role="dialog" aria-modal="true">
    <div class="modal" role="document">
        <button class="close" id="detailClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        <h3 id="detailTitle"></h3>
        <div style="color:var(--muted);font-size:13px;margin-bottom:8px" id="detailDate"></div>
        <p id="detailContent" style="white-space:pre-wrap"></p>
        <div style="margin-top:12px;text-align:right">
            <button id="detailFav" class="fav-btn">–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
        </div>
    </div>
</div>

<div id="modalSettings" class="modal-backdrop" style="display:none" role="dialog" aria-modal="true">
    <div class="modal" role="document">
        <button class="close" id="settingsClose" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
        <div class="settings-row">
            <div>–¢—ë–º–Ω–∞—è —Ç–µ–º–∞ (override)</div>
            <div id="themeToggle" class="toggle" role="switch" aria-checked="false"><div class="dot"></div></div>
        </div>
        <div style="margin-top:12px;color:var(--muted);font-size:13px">
            –¢–µ–º—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–µ—Ä—É—Ç—Å—è –∏–∑ Telegram (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã). –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—ã–±–æ—Ä –ª–æ–∫–∞–ª—å–Ω–æ.
        </div>
    </div>
</div>

<script>
/*
  Telegram Mini App ‚Äî –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π —Ñ–∞–π–ª.
  - mock data –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å fetchUrl –Ω–∞ –≤–Ω–µ—à–Ω–∏–π API
  - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å window.Telegram.WebApp
  - favorites –≤ localStorage
  - —Ç–µ–º–∞ –∏–∑ themeParams —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é override
*/

/* ========== –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ========== */
// –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å –Ω–æ–≤–æ—Å—Ç–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞, –ø–æ—Å—Ç–∞–≤—å—Ç–µ fetchUrl = '/fetch' (–∏–ª–∏ –ª—é–±–æ–π HTTPS-endpoint)
const fetchUrl = "https://saltprod.github.io/News/"; // '/fetch' –∏–ª–∏ null -> –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å mock BASE_NEWS

/* ========== Mock data (–ª–µ–≥–∫–æ –∑–∞–º–µ–Ω–∏—Ç—å) ========== */
const BASE_NEWS = [
    { id:'1', title:'–ù–æ–≤—ã–π –≥–æ—Ä–æ–¥—Å–∫–æ–π –ø–∞—Ä–∫ –æ—Ç–∫—Ä—ã–ª—Å—è –≤ —Ü–µ–Ω—Ç—Ä–µ', excerpt:'–ü–∞—Ä–∫ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∑–æ–Ω—ã –¥–ª—è –ø—Ä–æ–≥—É–ª–æ–∫, –¥–µ—Ç—Å–∫—É—é –ø–ª–æ—â–∞–¥–∫—É –∏ –≤–µ–ª–æ–¥–æ—Ä–æ–∂–∫–∏.', content:'–°–µ–≥–æ–¥–Ω—è –≤ —Ü–µ–Ω—Ç—Ä–µ –≥–æ—Ä–æ–¥–∞ –æ—Ç–∫—Ä—ã–ª—Å—è –Ω–æ–≤—ã–π –≥–æ—Ä–æ–¥—Å–∫–æ–π –ø–∞—Ä–∫. –û–Ω –≤–∫–ª—é—á–∞–µ—Ç –ø—Ä–æ–≥—É–ª–æ—á–Ω—ã–µ –∞–ª–ª–µ–∏, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–µ—Ç—Å–∫—É—é –ø–ª–æ—â–∞–¥–∫—É, –∑–æ–Ω—ã –¥–ª—è –ø–∏–∫–Ω–∏–∫–∞ –∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥–Ω—ã–µ –¥–æ—Ä–æ–∂–∫–∏. –û–∂–∏–¥–∞–µ—Ç—Å—è, —á—Ç–æ –ø–∞—Ä–∫ —Å—Ç–∞–Ω–µ—Ç –ø–æ–ø—É–ª—è—Ä–Ω—ã–º –º–µ—Å—Ç–æ–º –¥–ª—è —Å–µ–º–µ–π–Ω—ã—Ö –ø—Ä–æ–≥—É–ª–æ–∫ –∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π.', date:'2026-01-11' },
    { id:'2', title:'–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–∞—Ä—Ç–∞–ø –ø—Ä–∏–≤–ª—ë–∫ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π', excerpt:'–ö–æ–º–ø–∞–Ω–∏—è –∑–∞–∫—Ä—ã–ª–∞ —Ä–∞—É–Ω–¥ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π –Ω–∞ —Å—Ç–∞–¥–∏–∏ seed –∏ –≥–æ—Ç–æ–≤–∏—Ç –ø—Ä–æ–¥—É–∫—Ç –∫ –∑–∞–ø—É—Å–∫—É.', content:'–°—Ç–∞—Ä—Ç–∞–ø, —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—é—â–∏–π —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ä—É—Ç–∏–Ω–Ω—ã—Ö –∑–∞–¥–∞—á, –ø—Ä–∏–≤–ª—ë–∫ $1.2M –≤ —Ä–∞—É–Ω–¥–µ seed. –°—Ä–µ–¥—Å—Ç–≤–∞ –ø–æ–π–¥—É—Ç –Ω–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã –∏ –∑–∞–ø—É—Å–∫ –±–µ—Ç–∞-–≤–µ—Ä—Å–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞ –¥–ª—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤.', date:'2026-01-10' },
    { id:'3', title:'–ú–µ—Å—Ç–Ω—ã–µ –≤—ã–±–æ—Ä—ã –ø—Ä–æ—à–ª–∏ –≤ —à—Ç–∞—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ', excerpt:'–Ø–≤–∫–∞ –∏–∑–±–∏—Ä–∞—Ç–µ–ª–µ–π –ø—Ä–µ–≤—ã—Å–∏–ª–∞ –æ–∂–∏–¥–∞–Ω–∏—è, –Ω–∞–±–ª—é–¥–∞—é—Ç—Å—è –Ω–µ–±–æ–ª—å—à–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è.', content:'–í—ã–±–æ—Ä—ã –ø—Ä–æ—à–ª–∏ —Å –≤—ã—Å–æ–∫–æ–π —è–≤–∫–æ–π. –ù–∞–±–ª—é–¥–∞—Ç–µ–ª–∏ –æ—Ç–º–µ—á–∞—é—Ç –µ–¥–∏–Ω–∏—á–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–¥—É—Ä, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø–æ–≤–ª–∏—è–ª–∏ –Ω–∞ –∏—Ç–æ–≥.', date:'2026-01-09' },
    { id:'4', title:'–°–æ–≤–µ—Ç—ã –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏: 5 –ø—Ä–æ—Å—Ç—ã—Ö —à–∞–≥–æ–≤', excerpt:'–ù–µ–±–æ–ª—å—à–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –≤–Ω–µ–¥—Ä–∏—Ç—å —É–∂–µ —Å–µ–≥–æ–¥–Ω—è.', content:'1) –ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ —É—Ç—Ä–æ; 2) –†–∞–∑–±–∏–≤–∞–π—Ç–µ –∑–∞–¥–∞—á–∏ –Ω–∞ –±–ª–æ–∫–∏; 3) –û—Ç–∫–ª—é—á–∞–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è; 4) –î–µ–ª—è–π—Ç–µ –±–æ–ª—å—à–æ–π –ø—Ä–æ–µ–∫—Ç –Ω–∞ —ç—Ç–∞–ø—ã; 5) –†–µ–≥—É–ª—è—Ä–Ω–æ –¥–µ–ª–∞–π—Ç–µ –ø–∞—É–∑—ã.', date:'2026-01-08' }
];

/* ========== State –∏ –∫–ª—é—á–∏ localStorage ========== */
let news = [...BASE_NEWS];
let showOnlyFav = false;
const LS_FAV = 'tg_minapp_fav_v1';
const LS_THEME = 'tg_minapp_theme_override';

/* ========== –£—Ç–∏–ª–∏—Ç—ã ========== */
const $ = id => document.getElementById(id);
const loadFav = () => JSON.parse(localStorage.getItem(LS_FAV) || '[]');
const saveFav = arr => localStorage.setItem(LS_FAV, JSON.stringify(arr));
const isFav = id => loadFav().includes(id);
const toggleFav = id => { const fav = loadFav(); const i = fav.indexOf(id); if(i>=0) fav.splice(i,1); else fav.push(id); saveFav(fav); };

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function formatDate(d){ try{ const dt = new Date(d); return dt.toLocaleDateString(); }catch(e){ return d; } }
function setToggle(id, on){ const el = $(id); if(!el) return; el.classList.toggle('on', on); el.setAttribute('aria-checked', on ? 'true' : 'false'); }

/* ========== –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ª–µ–Ω—Ç—ã ========== */
function renderNews(){
    const container = $('news');
    container.innerHTML = '';
    let list = news.slice();
    if(showOnlyFav) list = list.filter(n => isFav(n.id));
    if(list.length === 0){ $('empty').style.display = 'block'; return; } else $('empty').style.display='none';
    list.forEach(item => {
        const card = document.createElement('article');
        card.className = 'card';
        card.setAttribute('tabindex','0');
        card.innerHTML = `<h3>${escapeHtml(item.title)}</h3>
                          <p>${escapeHtml(item.excerpt)}</p>
                          <div class="meta"><span>${escapeHtml(formatDate(item.date))}</span><button class="fav-btn" data-id="${item.id}">${isFav(item.id)?'‚òÖ –£–±—Ä–∞–Ω–Ω–æ–µ':'‚òÜ –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'}</button></div>`;
        card.addEventListener('click', ()=> openDetail(item.id));
        card.addEventListener('keydown', (e)=>{ if(e.key==='Enter') openDetail(item.id); });
        card.querySelector('.fav-btn').addEventListener('click', (ev)=>{
            ev.stopPropagation();
            toggleFav(ev.currentTarget.getAttribute('data-id'));
            renderNews();
        });
        container.appendChild(card);
    });
}

/* ========== –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π ========== */
function openDetail(id){
    const item = news.find(n => n.id === id);
    if(!item) return;
    $('detailTitle').textContent = item.title;
    $('detailDate').textContent = formatDate(item.date);
    $('detailContent').textContent = item.content;
    $('detailFav').textContent = isFav(id) ? '–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ';
    $('detailFav').onclick = () => { toggleFav(id); $('detailFav').textContent = isFav(id) ? '–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'; renderNews(); };
    $('modalDetail').style.display = 'flex';
}
function closeDetail(){ $('modalDetail').style.display = 'none'; }

/* ========== Settings modal –∏ —Ç–µ–º–∞ ========== */
function applyTelegramTheme(themeParams){
    // override –∏–∑ localStorage: 'dark' | 'light' | null
    const override = localStorage.getItem(LS_THEME);
    const tgIsDark = themeParams?.theme === 'dark' || themeParams?.is_dark;
    const isDark = override ? (override === 'dark') : tgIsDark;
    const tp = themeParams || {};
    const bg = tp.bg_color || tp.background_color || (isDark ? '#0b1220' : '#ffffff');
    const surface = tp.secondary_bg_color || (isDark ? '#071022' : '#f6f7f9');
    const text = tp.text_color || (isDark ? '#e6eef8' : '#111827');
    const muted = tp.hint_color || (isDark ? '#9fb3d6' : '#6b7280');
    const accent = tp.button_color || tp.accent_color || '#2a8cff';
    const pill = tp.section_bg_color || (isDark ? 'rgba(255,255,255,0.06)' : '#e6f0ff');

    const set = (k,v) => document.documentElement.style.setProperty(k, v);
    set('--bg', bg); set('--surface', surface); set('--text', text); set('--muted', muted); set('--accent', accent); set('--pill-bg', pill);
    setToggle('themeToggle', isDark);
}

/* ========== –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π (mock –∏–ª–∏ fetch) ========== */
async function loadNews(){
    if(fetchUrl){
        try{
            const res = await fetch(fetchUrl, { cache: "no-store" });
            if(!res.ok) throw new Error('fetch failed: ' + res.status);
            const data = await res.json();
            // –æ–∂–∏–¥–∞–µ—Ç—Å—è –º–∞—Å—Å–∏–≤ {id,title,excerpt,content,date}
            news = Array.isArray(data) ? data : news;
        }catch(e){
            console.warn('Fetch news failed, falling back to mock', e);
            news = [...BASE_NEWS];
        }
    } else {
        news = [...BASE_NEWS];
    }
    renderNews();
}

/* ========== –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ (—Å–∏–º—É–ª—è—Ü–∏—è + —Ä–µ–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞) ========== */
async function refresh(){
    if(fetchUrl){
        await loadNews();
    } else {
        // prepend generated item
        const now = new Date();
        const id = String(Date.now());
        const title = `–°–≤–µ–∂–∞—è –Ω–æ–≤–æ—Å—Ç—å ${now.toLocaleTimeString()}`;
        news.unshift({ id, title, excerpt: '–≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–µ—Å—Ç–æ–≤–∞—è –Ω–æ–≤–æ—Å—Ç—å.', content: title + '\n\n–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ mock.', date: now.toISOString().slice(0,10) });
        renderNews();
    }
}

/* ========== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram ========== */
function init(){
    // –∫–Ω–æ–ø–∫–∏
    $('btnRefresh').addEventListener('click', ()=> refresh());
    $('btnFav').addEventListener('click', ()=>{
        showOnlyFav = !showOnlyFav;
        $('btnFav').textContent = showOnlyFav ? 'üîñ –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ' : '‚òÜ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ';
        renderNews();
    });
    $('btnSettings').addEventListener('click', ()=> $('modalSettings').style.display = 'flex');
    $('btnClose').addEventListener('click', ()=> {
        // prefer Telegram close, fallback window.close for debug
        const WebApp = window.Telegram?.WebApp;
        if(WebApp && typeof WebApp.close === 'function') WebApp.close();
        else window.close();
    });

    // –º–æ–¥–∞–ª–∫–∏: –∑–∞–∫—Ä—ã—Ç—å –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω –∏–ª–∏ –∫—Ä–µ—Å—Ç–∏–∫—É
    $('detailClose').addEventListener('click', closeDetail);
    $('modalDetail').addEventListener('click', (e)=> { if(e.target === $('modalDetail')) closeDetail(); });
    $('settingsClose').addEventListener('click', ()=> $('modalSettings').style.display = 'none');
    $('modalSettings').addEventListener('click', (e)=> { if(e.target === $('modalSettings')) $('modalSettings').style.display = 'none'; });

    // –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã (override)
    $('themeToggle').addEventListener('click', ()=>{
        const on = $('themeToggle').classList.toggle('on');
        setToggle('themeToggle', on);
        localStorage.setItem(LS_THEME, on ? 'dark' : 'light');
        applyTelegramTheme(window.Telegram?.WebApp?.themeParams || {});
    });

    // Esc –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫–∏
    document.addEventListener('keydown', (e)=> { if(e.key === 'Escape'){ closeDetail(); $('modalSettings').style.display = 'none'; } });

    // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö + Telegram
    const WebApp = window.Telegram?.WebApp;
    try {
        if(WebApp){
            WebApp.ready();
            // –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (initDataUnsafe.user) - –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ, –Ω–æ —É–¥–æ–±–Ω–æ –¥–ª—è –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            const user = WebApp.initDataUnsafe?.user || window.Telegram?.WebApp?.initDataUnsafe?.user;
            if(user){
                const name = [user.first_name, user.last_name].filter(Boolean).join(' ');
                const username = user.username ? ('@' + user.username) : '';
                $('userInfo').textContent = name + (username ? ' ¬∑ ' + username : '');
            } else {
                $('userInfo').textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω';
            }

            // –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–µ–º—É –∏ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            applyTelegramTheme(WebApp.themeParams || {});
            if(typeof WebApp.onEvent === 'function'){
                WebApp.onEvent('themeChanged', ()=> applyTelegramTheme(WebApp.themeParams || {}));
            } else if(typeof WebApp.onThemeChange === 'function'){
                WebApp.onThemeChange(()=> applyTelegramTheme(WebApp.themeParams || {}));
            }
            // –ø–æ–ø—ã—Ç–∫–∞ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
            try{ if(typeof WebApp.expand === 'function') WebApp.expand(); }catch(e){ /* ignore */ }
        } else {
            // –µ—Å–ª–∏ –Ω–µ –≤ Telegram, –ø–æ–ø—ã—Ç–∫–∞ –ø—Ä–∏–º–µ–Ω–∏—Ç—å last override / system
            applyTelegramTheme(window.Telegram?.WebApp?.themeParams || {});
            $('userInfo').textContent = '–†–∞–±–æ—Ç–∞ –≤–Ω–µ Telegram (—Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏)';
        }
    } catch(e){
        console.warn('Telegram init error', e);
    }

    // –Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ª–µ–Ω—Ç—ã
    loadNews();
}

/* ========== Boot ========== */
init();

</script>
</body>
</html>