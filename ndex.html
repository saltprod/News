<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>–ú–æ—è –ª–µ–Ω—Ç–∞ ‚Äî Telegram Mini App</title>
    <style>
        :root{
            --bg:#ffffff;
            --surface:#f6f7f9;
            --text:#111827;
            --muted:#6b7280;
            --accent:#2a8cff;
            --pill-bg:#e6f0ff;
        }
        html,body{
            height:100%;
            margin:0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background:var(--bg);
            color:var(--text);
            -webkit-text-size-adjust:100%;
        }
        .app{
            min-height:100vh;
            display:flex;
            flex-direction:column;
        }
        header{
            padding:14px 16px;
            background:var(--surface);
            border-bottom:1px solid rgba(0,0,0,0.06);
            display:flex;
            align-items:center;
            justify-content:center;
            position:sticky;
            top:0;
            z-index:3;
        }
        header h1{
            margin:0;
            font-size:17px;
            font-weight:600;
            color:var(--text);
        }
        main{
            padding:12px 12px 84px; /* bottom space for fixed bar */
            flex:1 1 auto;
        }
        .news-list{
            display:flex;
            flex-direction:column;
            gap:10px;
        }
        .card{
            background:linear-gradient(180deg, rgba(255,255,255,0.6), transparent), var(--bg);
            border-radius:10px;
            padding:12px;
            box-shadow:0 1px 0 rgba(0,0,0,0.04);
            border:1px solid rgba(0,0,0,0.04);
            cursor:pointer;
        }
        .card h3{
            margin:0 0 6px 0;
            font-size:15px;
            line-height:1.2;
        }
        .card p{
            margin:0;
            color:var(--muted);
            font-size:13px;
            line-height:1.4;
            max-height:3.2em; /* ~2-3 lines */
            overflow:hidden;
        }
        .meta{
            margin-top:8px;
            font-size:12px;
            color:var(--muted);
            display:flex;
            justify-content:space-between;
            align-items:center;
        }
        .fav-btn{
            background:transparent;
            border:0;
            color:var(--accent);
            font-weight:600;
            font-size:12px;
            padding:6px 8px;
            border-radius:8px;
            cursor:pointer;
        }

        /* bottom bar */
        .bottom-bar{
            position:fixed;
            left:0;
            right:0;
            bottom:0;
            display:flex;
            gap:8px;
            padding:8px;
            background:var(--surface);
            border-top:1px solid rgba(0,0,0,0.06);
            justify-content:space-around;
            align-items:center;
            z-index:4;
        }
        .btn{
            background:var(--accent);
            color:white;
            border:0;
            padding:10px 14px;
            border-radius:10px;
            font-weight:600;
            font-size:14px;
            flex:1;
            margin:0 6px;
            max-width:160px;
        }
        .btn.ghost{
            background:transparent;
            border:1px solid rgba(0,0,0,0.06);
            color:var(--text);
        }
        /* modals */
        .modal-backdrop{
            position:fixed;
            left:0;right:0;top:0;bottom:0;
            background:rgba(0,0,0,0.35);
            display:flex;
            align-items:center;
            justify-content:center;
            z-index:10;
            padding:18px;
        }
        .modal{
            width:100%;
            max-width:720px;
            background:var(--bg);
            border-radius:12px;
            padding:16px;
            box-shadow:0 12px 30px rgba(0,0,0,0.2);
            max-height:90vh;
            overflow:auto;
        }
        .modal h3{ margin:0 0 8px 0; }
        .modal .close{
            float:right;
            background:transparent;border:0;font-size:18px;color:var(--muted);
            cursor:pointer;
        }
        .settings-row{ display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-top:1px solid rgba(0,0,0,0.04); }
        .toggle{
            width:44px; height:26px; background:var(--pill-bg); border-radius:20px; position:relative; cursor:pointer; flex:0 0 auto;
        }
        .toggle .dot{ width:20px;height:20px;background:white;border-radius:50%;position:absolute;top:3px;left:3px;transition:all .18s;box-shadow:0 1px 2px rgba(0,0,0,0.08); }
        .toggle.on{ background:var(--accent); }
        .toggle.on .dot{ left:21px; }

        /* empty state */
        .empty{ text-align:center; color:var(--muted); padding:40px 8px; }

        @media (prefers-color-scheme: dark){
            :root{
                --bg:#0b1220;
                --surface:#071022;
                --text:#e6eef8;
                --muted:#9fb3d6;
                --accent:#2a8cff;
                --pill-bg:rgba(255,255,255,0.06);
            }
        }

    </style>
</head>
<body>
<div class="app" id="app">
    <header>
        <h1>–ú–æ—è –ª–µ–Ω—Ç–∞</h1>
    </header>

    <main>
        <div id="news" class="news-list" aria-live="polite"></div>
        <div id="empty" class="empty" style="display:none">–ù–æ–≤–æ—Å—Ç–µ–π –Ω–µ—Ç. –ù–∞–∂–º–∏—Ç–µ ¬´–û–±–Ω–æ–≤–∏—Ç—å¬ª.</div>
    </main>

    <nav class="bottom-bar" role="navigation" aria-label="–ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å">
        <button id="btnRefresh" class="btn ghost">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <button id="btnFav" class="btn">‚òÜ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
        <button id="btnSettings" class="btn ghost">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </nav>
</div>

<!-- –º–æ–¥–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é hidden) -->
<div id="modalDetail" class="modal-backdrop" style="display:none" role="dialog" aria-modal="true">
    <div class="modal">
        <button class="close" id="detailClose">‚úï</button>
        <h3 id="detailTitle"></h3>
        <div style="color:var(--muted);font-size:13px;margin-bottom:8px" id="detailDate"></div>
        <p id="detailContent" style="white-space:pre-wrap"></p>
        <div style="margin-top:12px;text-align:right">
            <button id="detailFav" class="fav-btn">–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
        </div>
    </div>
</div>

<div id="modalSettings" class="modal-backdrop" style="display:none">
    <div class="modal">
        <button class="close" id="settingsClose">‚úï</button>
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
        <div class="settings-row">
            <div>–¢—ë–º–Ω–∞—è —Ç–µ–º–∞ (override)</div>
            <div id="themeToggle" class="toggle" role="switch" aria-checked="false"><div class="dot"></div></div>
        </div>
        <div style="margin-top:12px;color:var(--muted);font-size:13px">
            –¢–µ–º—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–µ—Ä—É—Ç—Å—è –∏–∑ Telegram (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã). –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—ã–±–æ—Ä –ª–æ–∫–∞–ª—å–Ω–æ.
        </div>
    </div>
</div>

<script>
(function(){
    // Mock data (news array)
    const BASE_NEWS = [
        { id:'1', title:'–ù–æ–≤—ã–π –≥–æ—Ä–æ–¥—Å–∫–æ–π –ø–∞—Ä–∫ –æ—Ç–∫—Ä—ã–ª—Å—è –≤ —Ü–µ–Ω—Ç—Ä–µ', excerpt:'–ü–∞—Ä–∫ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∑–æ–Ω—ã –¥–ª—è –ø—Ä–æ–≥—É–ª–æ–∫, –¥–µ—Ç—Å–∫—É—é –ø–ª–æ—â–∞–¥–∫—É –∏ –≤–µ–ª–æ–¥–æ—Ä–æ–∂–∫–∏.', content:'–°–µ–≥–æ–¥–Ω—è –≤ —Ü–µ–Ω—Ç—Ä–µ –≥–æ—Ä–æ–¥–∞ –æ—Ç–∫—Ä—ã–ª—Å—è –Ω–æ–≤—ã–π –≥–æ—Ä–æ–¥—Å–∫–æ–π –ø–∞—Ä–∫. –û–Ω –≤–∫–ª—é—á–∞–µ—Ç –ø—Ä–æ–≥—É–ª–æ—á–Ω—ã–µ –∞–ª–ª–µ–∏, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–µ—Ç—Å–∫—É—é –ø–ª–æ—â–∞–¥–∫—É, –∑–æ–Ω—ã –¥–ª—è –ø–∏–∫–Ω–∏–∫–∞ –∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥–Ω—ã–µ –¥–æ—Ä–æ–∂–∫–∏. –û–∂–∏–¥–∞–µ—Ç—Å—è, —á—Ç–æ –ø–∞—Ä–∫ —Å—Ç–∞–Ω–µ—Ç –ø–æ–ø—É–ª—è—Ä–Ω—ã–º –º–µ—Å—Ç–æ–º –¥–ª—è —Å–µ–º–µ–π–Ω—ã—Ö –ø—Ä–æ–≥—É–ª–æ–∫ –∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π.', date:'2026-01-11' },
        { id:'2', title:'–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–∞—Ä—Ç–∞–ø –ø—Ä–∏–≤–ª—ë–∫ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π', excerpt:'–ö–æ–º–ø–∞–Ω–∏—è –∑–∞–∫—Ä—ã–ª–∞ —Ä–∞—É–Ω–¥ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π –Ω–∞ —Å—Ç–∞–¥–∏–∏ seed –∏ –≥–æ—Ç–æ–≤–∏—Ç –ø—Ä–æ–¥—É–∫—Ç –∫ –∑–∞–ø—É—Å–∫—É.', content:'–°—Ç–∞—Ä—Ç–∞–ø, —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—é—â–∏–π —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ä—É—Ç–∏–Ω–Ω—ã—Ö –∑–∞–¥–∞—á, –ø—Ä–∏–≤–ª—ë–∫ $1.2M –≤ —Ä–∞—É–Ω–¥–µ seed. –°—Ä–µ–¥—Å—Ç–≤–∞ –ø–æ–π–¥—É—Ç –Ω–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã –∏ –∑–∞–ø—É—Å–∫ –±–µ—Ç–∞-–≤–µ—Ä—Å–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞ –¥–ª—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤.', date:'2026-01-10' },
        { id:'3', title:'–ú–µ—Å—Ç–Ω—ã–µ –≤—ã–±–æ—Ä—ã –ø—Ä–æ—à–ª–∏ –≤ —à—Ç–∞—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ', excerpt:'–Ø–≤–∫–∞ –∏–∑–±–∏—Ä–∞—Ç–µ–ª–µ–π –ø—Ä–µ–≤—ã—Å–∏–ª–∞ –æ–∂–∏–¥–∞–Ω–∏—è, –Ω–∞–±–ª—é–¥–∞—é—Ç—Å—è –Ω–µ–±–æ–ª—å—à–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è.', content:'–í—ã–±–æ—Ä—ã –ø—Ä–æ—à–ª–∏ —Å –≤—ã—Å–æ–∫–æ–π —è–≤–∫–æ–π. –ù–∞–±–ª—é–¥–∞—Ç–µ–ª–∏ –æ—Ç–º–µ—á–∞—é—Ç –µ–¥–∏–Ω–∏—á–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–¥—É—Ä, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø–æ–≤–ª–∏—è–ª–∏ –Ω–∞ –∏—Ç–æ–≥.', date:'2026-01-09' },
        { id:'4', title:'–°–æ–≤–µ—Ç—ã –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏: 5 –ø—Ä–æ—Å—Ç—ã—Ö —à–∞–≥–æ–≤', excerpt:'–ù–µ–±–æ–ª—å—à–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –≤–Ω–µ–¥—Ä–∏—Ç—å —É–∂–µ —Å–µ–≥–æ–¥–Ω—è.', content:'1) –ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ —É—Ç—Ä–æ; 2) –†–∞–∑–±–∏–≤–∞–π—Ç–µ –∑–∞–¥–∞—á–∏ –Ω–∞ –±–ª–æ–∫–∏; 3) –û—Ç–∫–ª—é—á–∞–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è; 4) –î–µ–ª—è–π—Ç–µ –±–æ–ª—å—à–æ–π –ø—Ä–æ–µ–∫—Ç –Ω–∞ —ç—Ç–∞–ø—ã; 5) –†–µ–≥—É–ª—è—Ä–Ω–æ –¥–µ–ª–∞–π—Ç–µ –ø–∞—É–∑—ã.', date:'2026-01-08' }
    ];

    // state
    let news = [...BASE_NEWS];
    let showOnlyFav = false;
    const LS_KEY = 'tg_minapp_fav_v1';
    const THEME_KEY = 'tg_minapp_theme_override';

    // helpers
    const $ = id => document.getElementById(id);
    const loadFav = () => JSON.parse(localStorage.getItem(LS_KEY) || '[]');
    const saveFav = (arr) => localStorage.setItem(LS_KEY, JSON.stringify(arr));
    const isFav = id => loadFav().includes(id);
    const toggleFav = id => {
        const fav = loadFav();
        const idx = fav.indexOf(id);
        if(idx>=0) fav.splice(idx,1); else fav.push(id);
        saveFav(fav);
    };

    // render
    const renderNews = () => {
        const container = $('news');
        container.innerHTML = '';
        let list = news.slice();
        if(showOnlyFav) list = list.filter(n=>isFav(n.id));
        if(list.length===0){
            $('empty').style.display='block';
            return;
        } else $('empty').style.display='none';

        list.forEach(item=>{
            const card = document.createElement('article');
            card.className='card';
            card.setAttribute('tabindex','0');
            card.innerHTML = `<h3>${escapeHtml(item.title)}</h3>
                              <p>${escapeHtml(item.excerpt)}</p>
                              <div class="meta"><span>${formatDate(item.date)}</span><button class="fav-btn" data-id="${item.id}">${isFav(item.id)?'‚òÖ –£–±—Ä–∞–Ω–Ω–æ–µ':'‚òÜ –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'}</button></div>`;
            // open detail on click / Enter
            card.addEventListener('click', ()=>openDetail(item.id));
            card.addEventListener('keydown', (e)=>{ if(e.key==='Enter') openDetail(item.id); });
            // fav button
            card.querySelector('.fav-btn').addEventListener('click', (ev)=>{
                ev.stopPropagation();
                const id = ev.currentTarget.getAttribute('data-id');
                toggleFav(id);
                renderNews();
            });
            container.appendChild(card);
        });
    };

    // detail modal
    const openDetail = (id) => {
        const item = news.find(n=>n.id===id);
        if(!item) return;
        $('detailTitle').textContent = item.title;
        $('detailDate').textContent = formatDate(item.date);
        $('detailContent').textContent = item.content;
        $('detailFav').textContent = isFav(id)?'–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ':'–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ';
        $('detailFav').onclick = () => {
            toggleFav(id);
            $('detailFav').textContent = isFav(id)?'–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ':'–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ';
            renderNews();
        };
        $('modalDetail').style.display='flex';
    };
    const closeDetail = ()=> $('modalDetail').style.display='none';

    // settings modal
    const openSettings = ()=> {
        const override = localStorage.getItem(THEME_KEY);
        const on = override === 'dark';
        setToggle('themeToggle', on);
        $('modalSettings').style.display='flex';
    };
    const closeSettings = ()=> $('modalSettings').style.display='none';

    // utility
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function formatDate(d){ try{ const dt = new Date(d); return dt.toLocaleDateString(); }catch(e){ return d; } }

    // refresh: simulate update (prepend new item with timestamp)
    const refresh = ()=>{
        const id = String(Date.now());
        const now = new Date();
        const title = `–°–≤–µ–∂–∞—è –Ω–æ–≤–æ—Å—Ç—å ${now.toLocaleTimeString()}`;
        news.unshift({ id, title, excerpt: '–≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–µ—Å—Ç–æ–≤–∞—è –Ω–æ–≤–æ—Å—Ç—å.', content: title + '\n\n–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ mock.', date: now.toISOString().slice(0,10) });
        if(!showOnlyFav) renderNews();
    };

    // theme handling: use Telegram.WebApp.themeParams with fallbacks, support override toggle
    function applyTelegramTheme(themeParams){
        // get override if user set it
        const override = localStorage.getItem(THEME_KEY); // 'dark'|'light'|null
        const isDark = override ? (override==='dark') : (themeParams && themeParams.theme && themeParams.theme === 'dark' || themeParams?.is_dark) ;
        // colors from themeParams if provided
        const tp = themeParams || {};
        // prefer explicit colors if present, otherwise defaults
        const bg = tp.bg_color || tp.background_color || (isDark ? '#0b1220' : '#ffffff');
        const surface = tp.secondary_bg_color || (isDark ? '#071022' : '#f6f7f9');
        const text = tp.text_color || (isDark ? '#e6eef8' : '#111827');
        const muted = tp.hint_color || (isDark ? '#9fb3d6' : '#6b7280');
        const accent = tp.button_color || tp.accent_color || '#2a8cff';
        const pill = tp.section_bg_color || (isDark ? 'rgba(255,255,255,0.06)' : '#e6f0ff');

        document.documentElement.style.setProperty('--bg', bg);
        document.documentElement.style.setProperty('--surface', surface);
        document.documentElement.style.setProperty('--text', text);
        document.documentElement.style.setProperty('--muted', muted);
        document.documentElement.style.setProperty('--accent', accent);
        document.documentElement.style.setProperty('--pill-bg', pill);
        setToggleVisual('themeToggle', isDark);
    }

    // toggle visuals
    function setToggle(id, on){
        const el = $(id);
        if(!el) return;
        el.classList.toggle('on', on);
        el.setAttribute('aria-checked', on ? 'true' : 'false');
    }
    function setToggleVisual(id, on){
        // same but used when theme applied
        setToggle(id, on);
    }

    // init
    function init(){
        // wire buttons
        $('btnRefresh').addEventListener('click', ()=> { refresh(); });
        $('btnFav').addEventListener('click', ()=>{
            showOnlyFav = !showOnlyFav;
            $('btnFav').textContent = showOnlyFav ? 'üîñ –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ' : '‚òÜ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ';
            renderNews();
        });
        $('btnSettings').addEventListener('click', openSettings);

        // modal closers
        $('detailClose').addEventListener('click', closeDetail);
        $('modalDetail').addEventListener('click', (e)=>{ if(e.target === $('modalDetail')) closeDetail(); });
        $('settingsClose').addEventListener('click', closeSettings);
        $('modalSettings').addEventListener('click', (e)=>{ if(e.target === $('modalSettings')) closeSettings(); });

        // theme toggle in settings
        $('themeToggle').addEventListener('click', ()=>{
            const on = $('themeToggle').classList.toggle('on');
            setToggle('themeToggle', on);
            localStorage.setItem(THEME_KEY, on ? 'dark' : 'light');
            applyTelegramTheme(window.Telegram?.WebApp?.themeParams || {});
        });

        // detail fav button handled when opened

        // initial render
        renderNews();

        // Telegram integration
        const WebApp = window.Telegram && window.Telegram.WebApp;
        try{
            if(WebApp){
                WebApp.ready();
                applyTelegramTheme(WebApp.themeParams || {});
                if(typeof WebApp.onEvent === 'function'){
                    WebApp.onEvent('themeChanged', ()=> applyTelegramTheme(WebApp.themeParams || {}));
                } else if(WebApp.onThemeChange) {
                    // older names
                    WebApp.onThemeChange(()=> applyTelegramTheme(WebApp.themeParams || {}));
                }
            } else {
                // still apply stored override or system preference
                applyTelegramTheme(window.Telegram?.WebApp?.themeParams || {});
            }
        }catch(e){
            console.warn('Telegram WebApp init error', e);
        }

        // accessibility: close modals with Esc
        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeDetail(); closeSettings(); } });
    }

    // small helper to shuffle (not used by default)
    function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

    // boot
    init();

})();
</script>
</body>
</html>
